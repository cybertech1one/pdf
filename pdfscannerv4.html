<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced PDF Security Scanner Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Core Dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- D3.js for advanced visualizations -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
   
  </script>
  <style>
    .dropzone { border: 2px dashed #ccc; transition: all 0.3s ease; }
    .dropzone.dragover { border-color: #4299e1; background: rgba(66,153,225,0.1); box-shadow: 0 0 10px rgba(66,153,225,0.3); }
    .loading { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tree-view { font-family: monospace; }
    .tree-view table { width: 100%; border-collapse: collapse; }
    .tree-view th, .tree-view td { border: 1px solid #ddd; padding: 8px; }
    .tree-view th { background-color: #f2f2f2; }
    .threat-score { font-size: 24px; font-weight: bold; text-align: center; padding: 20px; border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
    nav.tab-buttons button { flex: 1; text-align: center; padding: 0.75rem; border: none; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent; transition: background 0.2s ease; }
    nav.tab-buttons button.active { border-bottom: 2px solid #4299e1; color: #4299e1; }
    nav.tab-buttons button:hover { background: #f9fafb; }
    table { width: 100%; border-collapse: collapse; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .pdf-object { transition: all 0.2s ease; }
    .pdf-object:hover { background: #f0f9ff; }
    .highlight-match { background-color: rgba(255, 99, 71, 0.2); padding: 2px; border-radius: 3px; }
    .tooltip { position: absolute; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); z-index: 100; max-width: 300px; }
    .collapsible-section { overflow: hidden; transition: max-height 0.3s ease; }
    .pdf-tree-node { padding: 5px; cursor: pointer; }
    .pdf-tree-node:hover { background-color: #f0f8ff; }
    .pdf-tree-children { margin-left: 20px; }
    .sticky-header { position: sticky; top: 0; background: white; z-index: 10; }
    .pulse-animation { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.5); } 70% { box-shadow: 0 0 0 10px rgba(66, 153, 225, 0); } 100% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0); } }
    .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
    .status-safe { background-color: #48bb78; }
    .status-warning { background-color: #ecc94b; }
    .status-critical { background-color: #f56565; }
    .status-unknown { background-color: #a0aec0; }
    .metric-card { transition: transform 0.2s ease; }
    .metric-card:hover { transform: translateY(-5px); }
    .object-hierarchy svg { overflow: visible; }
    .node circle { fill: #fff; stroke: steelblue; stroke-width: 1.5px; }
    .node text { font: 12px sans-serif; }
    .link { fill: none; stroke: #ccc; stroke-width: 1.5px; }
    .timeline { position: relative; height: 50px; }
    .timeline-marker { position: absolute; width: 10px; height: 10px; background: red; border-radius: 50%; transform: translate(-50%, -50%); }
    .scanning-animation { background: linear-gradient(90deg, transparent, rgba(66,153,225,0.2), transparent); background-size: 200% 100%; animation: scanning 1.5s infinite; }
    @keyframes scanning { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    
    /* New advanced styles */
    .gauge-container { position: relative; width: 150px; height: 150px; margin: 0 auto; }
    .gauge-bg { fill: none; stroke: #e6e6e6; stroke-width: 15; }
    .gauge-fill { fill: none; stroke-width: 15; transition: stroke-dasharray 0.5s ease; }
    .gauge-center { fill: white; stroke: #e6e6e6; stroke-width: 1; }
    .gauge-value { font-family: sans-serif; font-size: 2rem; font-weight: bold; }
    .gauge-label { font-family: sans-serif; font-size: 1rem; }
    .heat-map { width: 100%; height: 200px; position: relative; }
    .heat-map-cell { position: absolute; border: 1px solid white; transition: background-color 0.3s ease; }
    .heat-map-tooltip { position: absolute; background: white; border: 1px solid #ddd; padding: 5px; border-radius: 3px; z-index: 100; pointer-events: none; }
    .pdf-structure-tree ul { list-style-type: none; padding-left: 20px; }
    .pdf-structure-tree li { position: relative; padding: 5px 0; }
    .pdf-structure-tree li::before { content: ""; position: absolute; top: 0; left: -10px; border-left: 1px solid #ccc; height: 100%; }
    .pdf-structure-tree li:last-child::before { height: 50%; }
    .pdf-structure-tree li::after { content: ""; position: absolute; top: 50%; left: -10px; width: 10px; border-top: 1px solid #ccc; }
    .node-toggle { cursor: pointer; user-select: none; }
    .node-toggle::before { content: "â–¶"; display: inline-block; margin-right: 5px; transition: transform 0.2s; }
    .node-toggle.open::before { transform: rotate(90deg); }
    .object-property { margin-left: 15px; }
    .object-key { color: #07a; }
    .object-string { color: #690; }
    .object-number { color: #905; }
    .object-boolean { color: #07a; }
    .object-null { color: #999; }
    .intelligent-insight { background-color: #ebf8ff; border-left: 4px solid #4299e1; padding: 10px; margin: 10px 0; }
    .vulnerability-detail { background-color: #fff5f5; border-left: 4px solid #f56565; padding: 10px; margin: 10px 0; }
    .recommendation-detail { background-color: #f0fff4; border-left: 4px solid #48bb78; padding: 10px; margin: 10px 0; }
    .code-preview { font-family: monospace; overflow-x: auto; white-space: pre; background-color: #f8f8f8; padding: 10px; border-radius: 4px; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
    .network-viz svg { width: 100%; height: 300px; }
    .network-viz line { stroke: #999; stroke-opacity: 0.6; }
    .network-viz circle { stroke: #fff; stroke-width: 1.5px; }
    .network-viz text { font-family: sans-serif; font-size: 10px; }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      nav.tab-buttons { overflow-x: auto; flex-wrap: nowrap; }
      nav.tab-buttons button { min-width: 100px; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">
        Advanced PDF Security Scanner Pro
        <span class="text-sm font-normal text-gray-500 block mt-2">Enterprise-Grade Deep Analysis &amp; Threat Detection</span>
      </h1>
      
      <!-- File Input -->
      <div class="dropzone rounded-lg px-8 py-12 text-center mb-10" id="dropZone">
        <div class="mb-4">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="mt-2">
            <input type="file" id="pdfInput" accept="application/pdf" class="hidden">
            <label for="pdfInput" class="cursor-pointer bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition inline-block">
              Select PDF File
            </label>
            <p class="mt-2 text-sm text-gray-500">or drag &amp; drop PDF here</p>
          </div>
        </div>
      </div>
      
      <!-- Buttons -->
      <div class="flex justify-center flex-wrap gap-4 mb-8">
        <div class="relative">
          <button id="scanButton" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2
                   M9 5a2 2 0 002 2h2a2 2 0 002-2
                   M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Start Deep Scan <span id="spinner" class="loading hidden"></span>
          </button>
          <div id="scanLevelDropdown" class="absolute hidden bg-white mt-2 py-2 w-48 rounded-md shadow-xl z-50">
            <button data-level="quick" class="w-full text-left px-4 py-2 hover:bg-blue-50">Quick Scan</button>
            <button data-level="standard" class="w-full text-left px-4 py-2 hover:bg-blue-50">Standard Scan</button>
            <button data-level="deep" class="w-full text-left px-4 py-2 hover:bg-blue-50">Deep Scan</button>
            <button data-level="forensic" class="w-full text-left px-4 py-2 hover:bg-blue-50">Forensic Analysis</button>
          </div>
        </div>
        <button id="downloadReport" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition hidden flex items-center">
          <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3
                 m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Download Report
        </button>
        <div class="relative">
          <button id="exportOptionsButton" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition hidden flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export
          </button>
          <div id="exportOptionsDropdown" class="absolute hidden bg-white mt-2 py-2 w-48 rounded-md shadow-xl z-50">
            <button id="exportJSON" class="w-full text-left px-4 py-2 hover:bg-purple-50">JSON Report</button>
            <button id="exportPDF" class="w-full text-left px-4 py-2 hover:bg-purple-50">PDF Report</button>
            <button id="exportCSV" class="w-full text-left px-4 py-2 hover:bg-purple-50">CSV Summary</button>
            <button id="exportHTML" class="w-full text-left px-4 py-2 hover:bg-purple-50">HTML Report</button>
          </div>
        </div>
      </div>
      
      <!-- Progress -->
      <div id="progressContainer" class="hidden mb-8">
        <div class="flex justify-between mb-2">
          <span id="progressText" class="text-sm font-medium text-gray-700">Initializing...</span>
          <span id="progressPercent" class="text-sm font-medium text-gray-700">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 scanning-animation" style="width: 0%"></div>
        </div>
        <div id="progressPhase" class="mt-1 text-xs text-gray-500">Preparing scan...</div>
        <div id="progressDetails" class="mt-2 text-sm text-gray-500"></div>
        
        <!-- Detailed Task Progress -->
        <div id="detailedProgress" class="mt-4 hidden">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Analysis Tasks</h4>
          <div class="space-y-3">
            <div class="task-item">
              <div class="flex justify-between mb-1">
                <span class="text-xs">Structure analysis</span>
                <span class="text-xs task-status">Waiting...</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="task-progress-bar bg-blue-600 h-1.5 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            <div class="task-item">
              <div class="flex justify-between mb-1">
                <span class="text-xs">Content extraction</span>
                <span class="text-xs task-status">Waiting...</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="task-progress-bar bg-blue-600 h-1.5 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            <div class="task-item">
              <div class="flex justify-between mb-1">
                <span class="text-xs">Security scanning</span>
                <span class="text-xs task-status">Waiting...</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="task-progress-bar bg-blue-600 h-1.5 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            <div class="task-item">
              <div class="flex justify-between mb-1">
                <span class="text-xs">Threat analysis</span>
                <span class="text-xs task-status">Waiting...</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="task-progress-bar bg-blue-600 h-1.5 rounded-full" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Results -->
      <div id="resultsDashboard" class="hidden">
        <!-- Summary Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="mb-4 md:mb-0">
              <h2 class="text-2xl font-bold text-gray-800">Security Analysis Results</h2>
              <p class="text-gray-500" id="scanTimestamp">Scanned on: --</p>
            </div>
            <div class="flex items-center">
              <div class="mr-4 text-right">
                <div class="text-sm text-gray-500">Scan Level</div>
                <div class="font-semibold" id="scanLevelDisplay">Standard</div>
              </div>
              <div id="summaryThreatScore" class="rounded-full w-16 h-16 flex items-center justify-center text-white font-bold text-2xl">--</div>
            </div>
          </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-10">
          <!-- Left Column - Key Metrics -->
          <div class="md:col-span-4 space-y-6">
            <!-- Threat Gauge -->
            <div class="bg-white rounded-lg shadow p-6 text-center">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Threat Score</h3>
              <div id="threatGaugeContainer" class="gauge-container"></div>
              <div id="threatVerdictText" class="mt-3 text-sm"></div>
            </div>
            
            <!-- Quick Stats Cards -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Key Metrics</h3>
              <div class="metrics-grid">
                <div class="metric-card bg-blue-50 p-4 rounded-lg">
                  <div class="text-xs text-blue-700 uppercase">Issues</div>
                  <div class="text-2xl font-bold text-blue-800" id="totalIssuesMetric">0</div>
                </div>
                <div class="metric-card bg-red-50 p-4 rounded-lg">
                  <div class="text-xs text-red-700 uppercase">Critical</div>
                  <div class="text-2xl font-bold text-red-800" id="criticalIssuesMetric">0</div>
                </div>
                <div class="metric-card bg-orange-50 p-4 rounded-lg">
                  <div class="text-xs text-orange-700 uppercase">High</div>
                  <div class="text-2xl font-bold text-orange-800" id="highIssuesMetric">0</div>
                </div>
                <div class="metric-card bg-yellow-50 p-4 rounded-lg">
                  <div class="text-xs text-yellow-700 uppercase">Medium</div>
                  <div class="text-2xl font-bold text-yellow-800" id="mediumIssuesMetric">0</div>
                </div>
              </div>
            </div>
            
            <!-- PDF Properties -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Document Properties</h3>
              <div id="quickStats" class="text-sm text-gray-700"></div>
            </div>
          </div>
          
          <!-- Middle Column - Charts & Risks -->
          <div class="md:col-span-4 space-y-6">
            <!-- Risk Categories Chart -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Risk Categories</h3>
              <canvas id="riskChart" height="250"></canvas>
            </div>
            
            <!-- Risk Heatmap -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Document Risk Heatmap</h3>
              <div id="riskHeatmapContainer" class="heat-map"></div>
            </div>
          </div>
          
          <!-- Right Column - Intelligent Insights -->
          <div class="md:col-span-4 space-y-6">
            <!-- Top Threats -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Top Threats</h3>
              <div id="topThreatsContainer" class="space-y-4"></div>
            </div>
            
            <!-- Intelligence Insights -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Intelligence Insights</h3>
              <div id="intelligentInsights" class="space-y-3"></div>
            </div>
            
            <!-- Document Integrity -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Document Integrity</h3>
              <div id="integrityContainer">
                <div class="flex items-center mb-2">
                  <span class="status-indicator" id="signatureStatus"></span>
                  <span class="text-sm" id="signatureStatusText">Digital Signature: Checking...</span>
                </div>
                <div class="flex items-center mb-2">
                  <span class="status-indicator" id="encryptionStatus"></span>
                  <span class="text-sm" id="encryptionStatusText">Encryption: Checking...</span>
                </div>
                <div class="flex items-center mb-2">
                  <span class="status-indicator" id="modificationStatus"></span>
                  <span class="text-sm" id="modificationStatusText">Modifications: Checking...</span>
                </div>
                <div class="flex items-center">
                  <span class="status-indicator" id="consistencyStatus"></span>
                  <span class="text-sm" id="consistencyStatusText">Structure Consistency: Checking...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6 sticky-header bg-white">
          <nav class="tab-buttons flex" aria-label="Tabs">
            <button class="tab-button active" data-tab="security">Security Analysis</button>
            <button class="tab-button" data-tab="structure">PDF Structure</button>
            <button class="tab-button" data-tab="objects">Objects &amp; Actions</button>
            <button class="tab-button" data-tab="metadata">Metadata</button>
            <button class="tab-button" data-tab="javascript">JavaScript</button>
            <button class="tab-button" data-tab="preview">Content Preview</button>
            <button class="tab-button" data-tab="network">Network</button>
            <button class="tab-button" data-tab="recommendations">Recommendations</button>
          </nav>
        </div>
        
        <div class="space-y-8">
          <!-- Security Analysis Tab -->
          <div id="securityTab" class="tab-content active">
            <div class="mb-6 bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-700">Security Issues</h3>
                <div class="flex items-center">
                  <label class="mr-2 text-sm text-gray-600">Filter:</label>
                  <select id="securitySeverityFilter" class="border rounded px-2 py-1 text-sm">
                    <option value="all">All Issues</option>
                    <option value="critical">Critical Only</option>
                    <option value="high">High & Above</option>
                    <option value="medium">Medium & Above</option>
                  </select>
                </div>
              </div>
              <div id="securityResults" class="space-y-4">
                <div class="text-center py-10">
                  <div class="inline-block p-3 rounded-full bg-blue-50 mb-4">
                    <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                  </div>
                  <p class="text-gray-500">Select a file and run a scan to see security analysis results</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- PDF Structure Tab -->
          <div id="structureTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Document Structure</h3>
                <div id="pdfStructure" class="max-h-[600px] overflow-auto"></div>
              </div>
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Object Hierarchy</h3>
                <div id="objectHierarchy" class="h-[600px] overflow-auto"></div>
              </div>
            </div>
          </div>
          
          <!-- Objects Tab -->
          <div id="objectsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-700">Object Analysis</h3>
                <div class="flex items-center space-x-2">
                  <input type="text" id="objectSearchInput" placeholder="Search objects..." class="border rounded px-3 py-1 text-sm w-64">
                  <select id="objectTypeFilter" class="border rounded px-2 py-1 text-sm">
                    <option value="all">All Types</option>
                    <option value="annotation">Annotations</option>
                    <option value="action">Actions</option>
                    <option value="form">Form Fields</option>
                    <option value="javascript">JavaScript</option>
                    <option value="embedded">Embedded Files</option>
                  </select>
                </div>
              </div>
              <div id="objectTable" class="overflow-x-auto max-h-[600px]"></div>
            </div>
          </div>
          
          <!-- Metadata Tab -->
          <div id="metadataTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Document Metadata</h3>
                <div id="metadata" class="font-mono text-sm p-4 bg-gray-50 rounded-md max-h-[400px] overflow-auto"></div>
              </div>
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Extended Properties</h3>
                <div id="extendedMetadata" class="space-y-4"></div>
              </div>
              <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Author Information</h3>
                <div id="authorMetadata" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
              </div>
            </div>
          </div>

          <!-- JavaScript Tab (New) -->
          <div id="javascriptTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">JavaScript Analysis</h3>
              <div id="javascriptContent" class="space-y-6">
                <div id="jsStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <!-- Stats will be populated here -->
                </div>
                <div id="jsCodeBlocks" class="space-y-6">
                  <!-- Code blocks will be displayed here -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Content Preview Tab -->
          <div id="previewTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Text Content</h3>
                <div class="flex justify-between items-center mb-2">
                  <div class="text-sm text-gray-500">Viewing first 100KB of text</div>
                  <button id="expandTextBtn" class="text-sm text-blue-500 hover:text-blue-700">Show All</button>
                </div>
                <textarea id="pdfText" readonly class="w-full h-96 p-4 font-mono text-sm border rounded bg-gray-50"></textarea>
              </div>
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Safe Content Preview</h3>
                <div id="safePreviewContainer" class="border rounded p-4 h-96 overflow-auto bg-gray-50">
                  <div class="text-center py-10 text-gray-500">
                    <p>Preview not available. Run a scan first.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Network Tab (New) -->
          <div id="networkTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Network Activity</h3>
                <div id="networkActivityTable" class="overflow-x-auto"></div>
              </div>
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Domain Connections</h3>
                <div id="networkVisualization" class="network-viz"></div>
              </div>
            </div>
          </div>
          
          <!-- Recommendations Tab (New) -->
          <div id="recommendationsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
              <h3 class="text-lg font-semibold mb-4 text-gray-700">Security Recommendations</h3>
              <div id="securityRecommendations" class="space-y-5"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="mt-8 text-center text-gray-500 text-sm">
      <p>Advanced PDF Security Scanner Pro v2.0 | Enterprise-Grade Security Analysis</p>
    </div>
  </div>
  
  <script>
    // ==============================================
    // ENHANCED SECURITY PATTERNS
    // ==============================================
    
    const securityPatterns = {
      javascript: {
        patterns: [
          { regex: /\/JavaScript|\/JS\s*\(/gi, severity: "critical", description: "JavaScript action detected in PDF" },
          { regex: /eval\(|new\s+Function|setTimeout|setInterval/gi, severity: "critical", description: "Dynamic code execution" },
          { regex: /Function\(['"`]return.*?['"`]\)/gi, severity: "critical", description: "Suspicious function construction" },
          { regex: /document\.|window\.|global\.|process\.|require\(|import\s+|module\./gi, severity: "high", description: "DOM or Node.js manipulation" },
          { regex: /this\.exportDataObject\s*\(|this\.mailDoc\s*\(|this\.submitForm\s*\(|this\.print\s*\(/gi, severity: "high", description: "PDF API method calls" },
          { regex: /app\.launchURL\s*\(|app\.execMenuItem\s*\(|app\.alert\s*\(/gi, severity: "high", description: "Acrobat app API usage" },
          { regex: /\.getAnnots|\.getField|\.getIcon|\.getLinks/gi, severity: "high", description: "PDF object access methods" },
          { regex: /\\x[0-9A-Fa-f]{2}|\\u[0-9A-Fa-f]{4}|%u[0-9A-Fa-f]{4}/gi, severity: "medium", description: "Encoded characters" },
          { regex: /unescape\s*\(|String\.fromCharCode\s*\(/gi, severity: "medium", description: "Character decoding functions" },
          { regex: /(\w+)\s*=\s*['"`]([^'"`]{100,})['"`]/gi, severity: "medium", description: "Large string assignment" },
          { regex: /(\w+)\[['"`](\w+)['"`]\]\s*\(/gi, severity: "medium", description: "Dynamic property method call" },
          { regex: /\btry\s*\{[\s\S]*?\}\s*catch/gi, severity: "low", description: "Error handling around suspicious code" },
          { regex: /\bwith\s*\([^)]+\)/gi, severity: "medium", description: "With statement (deprecated)" },
          { regex: /\bWebSocket\b|\bFetch\b|\bXMLHttpRequest\b/gi, severity: "high", description: "Network communication APIs" },
          { regex: /\baddEventListener\(|\battachEvent\(/gi, severity: "medium", description: "Event listener registration" },
          { regex: /\bworker\b|\bServiceWorker\b/gi, severity: "high", description: "Web Worker APIs" },
          { regex: /\bconsole\.\w+\(/gi, severity: "low", description: "Console logging" },
          { regex: /\blocalStorage\b|\bsessionStorage\b|\bindexedDB\b/gi, severity: "medium", description: "Browser storage access" },
          { regex: /\bnavigator\.[^\s(]+/gi, severity: "medium", description: "Navigator object access" },
          { regex: /\blocation\.[^\s(]+|\blocation\s*=/gi, severity: "high", description: "Location object manipulation" }
        ],
        description: "Detection of embedded or injected JavaScript code, including obfuscated scripts and potentially dangerous APIs."
      },
      networkActivity: {
        patterns: [
          { regex: /(https?|ftp|file|data|blob):\/\/[^\s<>"']+/gi, severity: "medium", description: "URL reference" },
          { regex: /\/URI\s*\(|\/URL\s*\(|\/Launch\s*\(|\/SubmitForm/gi, severity: "high", description: "URI action in PDF" },
          { regex: /\/GoTo(?:E|R)?|\/Launch|\/Thread|\/Sound/gi, severity: "medium", description: "Navigation action" },
          { regex: /file:\/\/[^\s<>"']+/gi, severity: "medium", description: "Local file reference" },
          { regex: /\/S\s*\/URI/gi, severity: "medium", description: "URI link annotation" },
          { regex: /POST|GET|PUT|DELETE|PATCH|HEAD|OPTIONS/gi, severity: "high", description: "HTTP method reference" },
          { regex: /var\s+xhr\s*=\s*new\s+XMLHttpRequest/gi, severity: "high", description: "XHR initialization" },
          { regex: /fetch\s*\(\s*['"`][^'"`]+['"`]/gi, severity: "high", description: "Fetch API usage" },
          { regex: /WebSocket\s*\(\s*['"`][^'"`]+['"`]/gi, severity: "high", description: "WebSocket initialization" },
          { regex: /http[s]?:\/\/(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+/gi, severity: "medium", description: "HTTP URL" },
          { regex: /\/F\s*\(\s*(https?|ftp|file):\/\/[^\s<>"']+\s*\)/gi, severity: "high", description: "Remote file reference" },
          { regex: /\.php\?|\.aspx\?|\.jsp\?|\.do\?/gi, severity: "medium", description: "Dynamic webpage with parameters" },
          { regex: /content-type|content-length|authorization|x-requested-with/gi, severity: "medium", description: "HTTP header reference" },
          { regex: /application\/json|application\/x-www-form-urlencoded|multipart\/form-data/gi, severity: "low", description: "HTTP content type" },
          { regex: /\/\/[^/]+\.onion\//gi, severity: "high", description: "Tor hidden service reference" }
        ],
        description: "Detection of network calls, URL references, file URIs, and potential exfiltration channels."
      },
      pdfStructure: {
        patterns: [
          { regex: /\/OpenAction|\/AA|\/Launch|\/JavaScript|\/RichMedia/gi, severity: "critical", description: "Automatic action trigger" },
          { regex: /\/XFA|\/AcroForm|\/JBIG2Decode|\/CCITTFaxDecode/gi, severity: "high", description: "Complex PDF feature" },
          { regex: /\/ObjStm|\/XRef|\/EmbeddedFile|\/FileSpec/gi, severity: "medium", description: "Advanced structure element" },
          { regex: /\/Pages\/Kids\[\s*[0-9]+\s+[0-9]+\s+R/gi, severity: "low", description: "Document page structure" },
          { regex: /\/Type\s*\/Action/gi, severity: "high", description: "Action object" },
          { regex: /\/Type\s*\/Annot/gi, severity: "medium", description: "Annotation object" },
          { regex: /\/S\s*\/GoTo/gi, severity: "low", description: "Go-to action" },
          { regex: /\/S\s*\/JavaScript/gi, severity: "critical", description: "JavaScript action" },
          { regex: /\/S\s*\/Launch/gi, severity: "critical", description: "Launch action" },
          { regex: /\/S\s*\/URI/gi, severity: "medium", description: "URI action" },
          { regex: /\/S\s*\/Named/gi, severity: "medium", description: "Named action" },
          { regex: /\/S\s*\/SubmitForm/gi, severity: "high", description: "Form submission action" },
          { regex: /\/S\s*\/ImportData/gi, severity: "high", description: "Data import action" },
          { regex: /\/Linearized/gi, severity: "low", description: "Linearized PDF" },
          { regex: /\/StructTreeRoot/gi, severity: "low", description: "Structure tree" },
          { regex: /\/XObject\s*\/Subtype\s*\/Image/gi, severity: "low", description: "Image XObject" },
          { regex: /\/XObject\s*\/Subtype\s*\/Form/gi, severity: "medium", description: "Form XObject" },
          { regex: /\/Filter\s*\/ASCIIHexDecode/gi, severity: "low", description: "ASCII hex encoding" },
          { regex: /\/Filter\s*\/ASCII85Decode/gi, severity: "low", description: "ASCII85 encoding" },
          { regex: /\/Filter\s*\/LZWDecode/gi, severity: "low", description: "LZW compression" },
          { regex: /\/Filter\s*\/RunLengthDecode/gi, severity: "low", description: "Run length encoding" },
          { regex: /\/Filter\s*\/DCTDecode/gi, severity: "low", description: "DCT (JPEG) image" },
          { regex: /\/Pages\/Count\s+([1-9][0-9]*)/gi, severity: "info", description: "Page count" },
          { regex: /\/Version\s*\/([1-9]\.[0-9])/gi, severity: "info", description: "PDF version" },
          { regex: /\/Encrypt/gi, severity: "medium", description: "Encrypted PDF" },
          { regex: /\/ID\s*\[\s*<[0-9a-fA-F]+>\s*<[0-9a-fA-F]+>\s*\]/gi, severity: "low", description: "Document ID" },
          { regex: /\/Names/gi, severity: "medium", description: "Names dictionary" },
          { regex: /\/Dests/gi, severity: "low", description: "Destinations" },
          { regex: /\/OCProperties/gi, severity: "low", description: "Optional content properties" },
          { regex: /\/Outlines/gi, severity: "low", description: "Document outlines" }
        ],
        description: "Detection of anomalies in PDF structure, embedded objects, and potentially dangerous elements."
      },
      maliciousPatterns: {
        patterns: [
          { regex: /\b(?:cmd|shell|powershell|wscript)\b.*?\b(?:\/c|exec|run)/gi, severity: "critical", description: "Command execution" },
          { regex: /\b(?:password|passwd|pwd|credential|token|api[_-]?key|secret)/gi, severity: "high", description: "Credential reference" },
          { regex: /(?:\\x[0-9a-fA-F]{2}|\\u[0-9a-fA-F]{4}|%u[0-9a-fA-F]{4}){3,}/gi, severity: "high", description: "Heavily encoded content" },
          { regex: /\bb64encode|\bb64decode|\bexec\(|base64decode|base64encode/gi, severity: "high", description: "Base64 handling" },
          { regex: /(onerror\s*=|onload\s*=|alert\s*\(|prompt\s*\(|confirm\s*\()/gi, severity: "medium", description: "Browser dialog or event handler" },
          { regex: /\/F\s*\([^)]+\.(exe|dll|bat|scr|vbs|ps1|sh)\)/gi, severity: "critical", description: "Executable file reference" },
          { regex: /curl\s+-o\s+|wget\s+/gi, severity: "high", description: "File download command" },
          { regex: /certutil\s+-decode|base64\s+-d/gi, severity: "high", description: "Binary decoding utility" },
          { regex: /eval\((?:.|\s)*?\+.*?\)/gi, severity: "critical", description: "Dynamic code evaluation" },
          { regex: /(rundll32|regsvr32|mshta|wmic)\s+/gi, severity: "critical", description: "Windows utility execution" },
          { regex: /(cd\s+[\/\\]|mkdir\s+|rmdir\s+|touch\s+)/gi, severity: "medium", description: "Filesystem command" },
          { regex: /(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\s+.*?FROM/gi, severity: "high", description: "SQL statement" },
          { regex: /\$\(|`.*?`|\$\{.*?\}/gi, severity: "high", description: "Command substitution" },
          { regex: /process.env|os.system|subprocess|child_process|Runtime.exec/gi, severity: "high", description: "Process execution API" },
          { regex: /chmod\s+[0-7]{3,4}|sudo\s+/gi, severity: "high", description: "Unix privilege command" },
          { regex: /net\s+user|net\s+localgroup|net\s+use/gi, severity: "high", description: "Windows user management" },
          { regex: /taskkill|tasklist|netstat -/gi, severity: "medium", description: "System information command" },
          { regex: /Invoke-Expression|iex\s+/gi, severity: "critical", description: "PowerShell execution" },
          { regex: /-nop\s+-[ec]|EncodedCommand/gi, severity: "critical", description: "PowerShell encoding/obfuscation" },
          { regex: /sc\s+create|sc\s+config|sc\s+start/gi, severity: "high", description: "Windows service manipulation" },
          { regex: /reg\s+add|reg\s+delete|regedit/gi, severity: "high", description: "Registry manipulation" },
          { regex: /schtasks\s+\/create/gi, severity: "high", description: "Scheduled task creation" },
          { regex: /cmd\.exe|powershell\.exe|bash\.exe|sh\.exe/gi, severity: "high", description: "Shell executable reference" },
          { regex: /"(?:[^"\\]|\\.){100,}"/g, severity: "medium", description: "Suspiciously long string" }
        ],
        description: "Detection of typical malicious commands, file references, and obfuscation patterns across multiple platforms."
      },
      xssAttacks: {
        patterns: [
          { regex: /<script[\s\S]*?>[\s\S]*?<\/script>/gi, severity: "critical", description: "Script tag" },
          { regex: /<img[^>]+src\s*=\s*['"]javascript:/gi, severity: "high", description: "JavaScript in image source" },
          { regex: /<iframe[\s\S]*?>[\s\S]*?<\/iframe>/gi, severity: "high", description: "Iframe element" },
          { regex: /on\w+\s*=\s*(["']?).*?\1/gi, severity: "medium", description: "Event handler attribute" },
          { regex: /document\.cookie|window\.location|document\.location/gi, severity: "medium", description: "DOM location/cookie access" },
          { regex: /<(style|link)[^>]+(javascript:)/gi, severity: "high", description: "JavaScript in style" },
          { regex: /expression\s*\(/gi, severity: "medium", description: "CSS expression" },
          { regex: /<form[\s\S]*?>[\s\S]*?<\/form>/gi, severity: "medium", description: "Form element" },
          { regex: /document\.write\s*\(/gi, severity: "high", description: "Document write" },
          { regex: /eval\s*\(|setTimeout\s*\(|setInterval\s*\(/gi, severity: "high", description: "Dynamic code execution" },
          { regex: /innerHTML|outerHTML|insertAdjacentHTML/gi, severity: "medium", description: "HTML injection point" },
          { regex: /createTextNode|createElement|appendChild|insertBefore/gi, severity: "medium", description: "DOM manipulation" },
          { regex: /\.src\s*=|\.href\s*=/gi, severity: "medium", description: "Source attribute assignment" },
          { regex: /&#x?\d+;|&[a-z]+;/gi, severity: "low", description: "HTML entity encoding" },
          { regex: /%[0-9A-Fa-f]{2}/g, severity: "low", description: "URL encoding" },
          { regex: /encodeURIComponent|decodeURIComponent|escape|unescape/gi, severity: "low", description: "URL encoding/decoding" }
        ],
        description: "Detection of common XSS injection patterns, HTML manipulation, and DOM-based vulnerabilities."
      },
      ssrfAndBeacons: {
        patterns: [
          { regex: /(?<![\w])(https?:\/\/(?:127\.0\.0\.1|localhost|169\.254\.\d+\.\d+))/gi, severity: "critical", description: "Local service access" },
          { regex: /(?<![\w])(https?:\/\/(10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.(1[6-9]|2[0-9]|3[0-1])\.\d+\.\d+))/gi, severity: "critical", description: "Private network access" },
          { regex: /https?:\/\/(exfil|callback|beacon|c2|command|collect|data|drop|dump)\.[^\s<>"']+/gi, severity: "high", description: "Suspicious domain name" },
          { regex: /https?:\/\/[^\s]*burpcollaborator\.net[^\s]*/gi, severity: "high", description: "Burp Collaborator reference" },
          { regex: /\/etc\/passwd|\/etc\/shadow|metadata\.google\.internal|169\.254\.169\.254/gi, severity: "high", description: "System file or metadata service" },
          { regex: /file:\/\/\/[a-zA-Z]:/gi, severity: "high", description: "Local file access" },
          { regex: /\/\/0177\.0\.0\.1|\/\/0x7f000001|\/\/2130706433/gi, severity: "critical", description: "Obfuscated localhost" },
          { regex: /intranet|internal|localhost|local|private|172\.(?:1[6-9]|2\d|3[01])|192\.168|10\./gi, severity: "high", description: "Internal network reference" },
          { regex: /amazonaws\.com\/latest\/meta-data|metadata\.google\.internal|metadata\.azure\.com/gi, severity: "high", description: "Cloud metadata service" },
          { regex: /instance-data|api\.telegram\.org|api\.discord\.com|graph\.facebook\.com/gi, severity: "medium", description: "API service" },
          { regex: /smtp-|mail\.|exchange\.|mta-|pop\.|pop3\.|imap\./gi, severity: "high", description: "Mail server reference" },
          { regex: /ldap:\/\/|ldaps:\/\/|adfs\.|kerberos\.|activedirectory\./gi, severity: "high", description: "Directory service reference" },
          { regex: /jenkins\.|gitlab\.|artifactory\.|nexus\.|sonar\.|docker\.|kubernetes\.|consul\./gi, severity: "high", description: "DevOps tool reference" },
          { regex: /redis:\/\/|mongodb:\/\/|postgres:\/\/|mysql:\/\/|jdbc:mysql:\/\/|jdbc:postgresql:\/\//gi, severity: "critical", description: "Database connection string" }
        ],
        description: "Detection of potential SSRF, callbacks, beacon endpoints, and internal/cloud resource access."
      },
      obfuscationAndHidden: {
        patterns: [
          { regex: /[A-Za-z0-9+\/]{40,}={0,2}/g, severity: "medium", description: "Base64-encoded content" },
          { regex: /[\u200B-\u200F\uFEFF\u2028\u2029]/g, severity: "medium", description: "Zero-width/invisible characters" },
          { regex: /(script){3,}/gi, severity: "high", description: "Keyword obfuscation" },
          { regex: /(?:['"][A-Za-z0-9]{10,}['"]\s*\+\s*){2,}/gi, severity: "medium", description: "String concatenation" },
          { regex: /(?:%[0-9A-Fa-f]{2}){20,}/g, severity: "medium", description: "Percent-encoded content" },
          { regex: /(?=.*\\x[0-9A-Fa-f]{2})(?=.*[A-Za-z0-9+\/]{20,}={0,2})/gi, severity: "critical", description: "Mixed encoding techniques" },
          { regex: /\[\s*'\s*\+\s*'\s*\]/gi, severity: "high", description: "Array notation obfuscation" },
          { regex: /(?:\\u00[0-9a-f]{2}){10,}/gi, severity: "high", description: "Unicode escape sequences" },
          { regex: /\\(?:[\r\n]|\\r|\\n)/gi, severity: "medium", description: "Escaped linebreaks" },
          { regex: /\\x[0-9A-Fa-f]{2}\\x[0-9A-Fa-f]{2}/gi, severity: "high", description: "Hexadecimal escape sequences" },
          { regex: /\.replace\(/gi, severity: "medium", description: "String replacement" },
          { regex: /\.split\(['"]\s*['"]\)\.join\(['"]\s*['"]\)/gi, severity: "medium", description: "Split/join obfuscation" },
          { regex: /atob\s*\(/gi, severity: "high", description: "Base64 decoding" },
          { regex: /String\.fromCharCode\(/gi, severity: "high", description: "Character code conversion" },
          { regex: /=\s*Function\((['"])[\s\S]+?\1\)/gi, severity: "critical", description: "Dynamic function creation" },
          { regex: /eval\s*\(\s*atob\s*\(/gi, severity: "critical", description: "Evaluated Base64 content" },
          { regex: /\\.\s*{{}/gi, severity: "medium", description: "Template literal obfuscation" },
          { regex: /\\.\s*\/[^\/]+\/[gimuy]*\s*(?:\.\s*(?:test|exec|match)\s*\(\s*)?/gi, severity: "medium", description: "Obfuscated RegExp" },
          { regex: /\(\s*\[\]\s*\+\s*\[\]\s*\)\s*\[\s*\+\s*\+\s*\+\s*\!\s*\[\]\s*\+\s*\+\s*\+\s*\!\s*\!\s*\[\]\s*\]/gi, severity: "critical", description: "JSFuck obfuscation" }
        ],
        description: "Detection of obfuscated or hidden content (including percent-encoding, mixed encoding, and concatenated strings)."
      },
      reverseShell: {
        patterns: [
          { regex: /bash\s+-i\s*>\&\s*\/dev\/tcp\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\/\d+\s+0>&1/gi, severity: "critical", description: "Bash TCP reverse shell" },
          { regex: /nc\s+-e\s+\/bin\/sh\s+\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\s+\d+/gi, severity: "critical", description: "Netcat reverse shell" },
          { regex: /ncat\s+-e\s+\/bin\/sh\s+\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\s+\d+/gi, severity: "critical", description: "Ncat reverse shell" },
          { regex: /perl\s+-e\s+'.*socket\(/gi, severity: "critical", description: "Perl reverse shell" },
          { regex: /python\s+-c\s+'.*socket\.socket\(/gi, severity: "critical", description: "Python reverse shell" },
          { regex: /php\s+-r\s+'.*fsockopen\(/gi, severity: "critical", description: "PHP reverse shell" },
          { regex: /powershell\s+-nop\s+-c\s+".*New-Object\s+Net\.Sockets\.TCPClient/gi, severity: "critical", description: "PowerShell reverse shell" },
          { regex: /cmd\.exe\s+\/c\s+start\s+\/b/gi, severity: "critical", description: "Windows command execution" },
          { regex: /powershell\s+-EncodedCommand/gi, severity: "critical", description: "PowerShell encoded command" },
          { regex: /IEX\s*\(\s*New-Object\s+Net\.WebClient\s*\)\.DownloadString\s*\(/gi, severity: "critical", description: "PowerShell download and execute" },
          { regex: /ruby\s+-rsocket\s+-e/gi, severity: "critical", description: "Ruby reverse shell" },
          { regex: /socat\s+.*?\s+TCP4:/gi, severity: "critical", description: "Socat reverse shell" },
          { regex: /mknod\s+.*?\s+p\s+.*?\s+\/bin\/sh/gi, severity: "critical", description: "Named pipe shell" },
          { regex: /\/bin\/bash\s+-i\s*>.*?&\s*\d+>.*?&\s*\d+/gi, severity: "critical", description: "Bash reverse shell variation" },
          { regex: /telnet\s+\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\s+\d+\s*\|\s*\/bin\/sh/gi, severity: "critical", description: "Telnet reverse shell" },
          { regex: /-nop\s+-w\s+hidden\s+-c\s+"/gi, severity: "critical", description: "PowerShell hidden execution" },
          { regex: /\/dev\/tcp|\/bin\/bash\s+-i/gi, severity: "critical", description: "Bash reverse shell component" },
          { regex: /New-Object\s+System\.Net\.Sockets\.TCPClient/gi, severity: "critical", description: "PowerShell TCP client" },
          { regex: /MemoryStream\(.*Convert\.FromBase64String/gi, severity: "critical", description: "Memory-based code execution" }
        ],
        description: "Detection of reverse shell commands, backdoor patterns, and remote access techniques."
      },
      macroDetection: {
        patterns: [
          { regex: /AutoOpen\s*\(/gi, severity: "critical", description: "Auto-opening macro" },
          { regex: /Sub\s+AutoOpen/gi, severity: "critical", description: "AutoOpen subroutine" },
          { regex: /Document_Open\s*\(/gi, severity: "critical", description: "Document open event" },
          { regex: /CreateObject\(["']WScript\.Shell["']\)/gi, severity: "high", description: "WScript Shell creation" },
          { regex: /AutoExec\s*\(/gi, severity: "critical", description: "Auto-execute macro" },
          { regex: /Workbook_Open\s*\(/gi, severity: "critical", description: "Workbook open event" },
          { regex: /Document_Close\s*\(/gi, severity: "critical", description: "Document close event" },
          { regex: /Shell\s*\(/gi, severity: "critical", description: "Shell command execution" },
          { regex: /VBA\.CreateObject/gi, severity: "high", description: "VBA object creation" },
          { regex: /ActiveDocument\.|ThisDocument\./gi, severity: "high", description: "Document object reference" },
          { regex: /Selection\.|ActiveCell\./gi, severity: "medium", description: "Selection manipulation" },
          { regex: /\.SaveAs\s/gi, severity: "high", description: "Document saving method" },
          { regex: /Chr\(\s*\d+\s*\)/gi, severity: "medium", description: "Character code conversion" },
          { regex: /\&H[0-9A-F]+/gi, severity: "medium", description: "Hexadecimal literals" },
          { regex: /CreateObject\(\s*["']Scripting\.FileSystemObject["']\s*\)/gi, severity: "high", description: "Filesystem object creation" },
          { regex: /\.Open\s+["'][^"']+\.exe["']|\.Open\s+["'][^"']+\.dll["']/gi, severity: "critical", description: "Opening executable files" },
          { regex: /Application\.Run/gi, severity: "high", description: "Dynamic macro execution" },
          { regex: /\bDim\s+(\w+)\s+As\s+Object/gi, severity: "medium", description: "Generic object declaration" },
          { regex: /Set\s+(\w+)\s*=\s*CreateObject\(/gi, severity: "high", description: "Object instantiation" },
          { regex: /ExecuteExcel4Macro/gi, severity: "critical", description: "Excel 4.0 macro execution" }
        ],
        description: "Detection of macros and VBA code execution patterns, commonly found in malicious documents."
      },
      htmlContent: {
        patterns: [
          { regex: /<html[\s\S]*?>[\s\S]*?<\/html>/gi, severity: "medium", description: "HTML document" },
          { regex: /<iframe[\s\S]*?>[\s\S]*?<\/iframe>/gi, severity: "high", description: "Iframe element" },
          { regex: /<form[\s\S]*?>[\s\S]*?<\/form>/gi, severity: "medium", description: "Form element" },
          { regex: /<script[\s\S]*?>[\s\S]*?<\/script>/gi, severity: "high", description: "Script element" },
          { regex: /<object[\s\S]*?>[\s\S]*?<\/object>/gi, severity: "high", description: "Object element" },
          { regex: /<embed[\s\S]*?>[\s\S]*?<\/embed>/gi, severity: "high", description: "Embed element" },
          { regex: /<applet[\s\S]*?>[\s\S]*?<\/applet>/gi, severity: "high", description: "Applet element" },
          { regex: /<meta[\s\S]*?>/gi, severity: "low", description: "Meta tag" },
          { regex: /<link[\s\S]*?>/gi, severity: "medium", description: "Link tag" },
          { regex: /<style[\s\S]*?>[\s\S]*?<\/style>/gi, severity: "low", description: "Style element" },
          { regex: /<a[\s\S]*?href\s*=\s*["']javascript:[^"']*["'][^>]*>/gi, severity: "high", description: "JavaScript link" },
          { regex: /<img[\s\S]*?src\s*=\s*["']javascript:[^"']*["'][^>]*>/gi, severity: "high", description: "JavaScript image source" },
          { regex: /<input[\s\S]*?>/gi, severity: "medium", description: "Input element" },
          { regex: /<button[\s\S]*?>[\s\S]*?<\/button>/gi, severity: "medium", description: "Button element" },
          { regex: /<svg[\s\S]*?>[\s\S]*?<\/svg>/gi, severity: "medium", description: "SVG element" },
          { regex: /<!DOCTYPE/gi, severity: "low", description: "DOCTYPE declaration" },
          { regex: /<table[\s\S]*?>[\s\S]*?<\/table>/gi, severity: "low", description: "Table element" },
          { regex: /<div[\s\S]*?>[\s\S]*?<\/div>/gi, severity: "low", description: "Div element" }
        ],
        description: "Detection of embedded HTML content, which could contain scripts, forms, or other interactive elements."
      },
      trackingAnalytics: {
        patterns: [
          { regex: /google-analytics\.com/gi, severity: "medium", description: "Google Analytics" },
          { regex: /analytics\.js/gi, severity: "medium", description: "Analytics script" },
          { regex: /segment\.com/gi, severity: "medium", description: "Segment analytics" },
          { regex: /mixpanel\.com/gi, severity: "medium", description: "Mixpanel analytics" },
          { regex: /tracking\.php/gi, severity: "medium", description: "Tracking script" },
          { regex: /pixel\.gif/gi, severity: "medium", description: "Tracking pixel" },
          { regex: /doubleclick\.net/gi, severity: "medium", description: "DoubleClick tracker" },
          { regex: /facebook\.com\/tr\?/gi, severity: "medium", description: "Facebook tracking pixel" },
          { regex: /googletagmanager\.com/gi, severity: "medium", description: "Google Tag Manager" },
          { regex: /linkedin\.com\/px/gi, severity: "medium", description: "LinkedIn tracking" },
          { regex: /hotjar\.com/gi, severity: "medium", description: "Hotjar analytics" },
          { regex: /clarity\.ms/gi, severity: "medium", description: "Microsoft Clarity" },
          { regex: /beacon\.js/gi, severity: "medium", description: "Analytics beacon" },
          { regex: /\/collect\?/gi, severity: "medium", description: "Data collection endpoint" },
          { regex: /fingerprint|canvas\+fingerprint/gi, severity: "high", description: "Browser fingerprinting" },
          { regex: /user-agent|navigator\.userAgent/gi, severity: "medium", description: "User agent detection" }
        ],
        description: "Detection of tracking and analytics scripts, which could be used to monitor user activity."
      },
      malwarePayloads: {
        patterns: [
          { regex: /buf\s*=\s*["'](?:\\x[0-9A-Fa-f]{2}){50,}["']/gi, severity: "critical", description: "Shellcode buffer" },
          { regex: /(?:\x90){20,}/gi, severity: "high", description: "NOP sled" },
          { regex: /(?:IEX\s*\(|Invoke-Expression\s*\().*?(?:[A-Za-z0-9+/]{100,})/gi, severity: "critical", description: "PowerShell encoded payload" },
          { regex: /<\?php\s+.*?(?:fsockopen|exec|system|passthru|popen)\(/gi, severity: "critical", description: "PHP shell commands" },
          { regex: /reverse[\s_-]*shell/i, severity: "critical", description: "Reverse shell reference" },
          { regex: /\/F\s*\([^)]+\.(exe|dll|bat|scr)\)/gi, severity: "critical", description: "Executable file reference" },
          { regex: /(?:[0-9A-Fa-f]{2}\s+){100,}/g, severity: "high", description: "Hex byte sequence" },
          { regex: /eval\((?:.|\s)*?\+.*?\)/gi, severity: "critical", description: "Evaluated concatenated code" },
          { regex: /CreateProcess\s*\(/gi, severity: "critical", description: "Process creation API" },
          { regex: /VirtualAllocEx\s*\(/gi, severity: "critical", description: "Memory allocation API" },
          { regex: /WriteProcessMemory\s*\(/gi, severity: "critical", description: "Memory writing API" },
          { regex: /CreateRemoteThread\s*\(/gi, severity: "critical", description: "Remote thread creation" },
          { regex: /MZ[\x00-\xFF]{64,}/gi, severity: "critical", description: "Embedded PE file" },
          { regex: /kernel32\.dll|ntdll\.dll|advapi32\.dll|user32\.dll/gi, severity: "high", description: "Windows system DLL reference" },
          { regex: /LoadLibrary|GetProcAddress|CreateThread|VirtualProtect/gi, severity: "high", description: "Windows API function" },
          { regex: /meterpreter|metasploit|payload|cobaltstrike|beacon/gi, severity: "critical", description: "Known malware framework" },
          { regex: /botnet|command\s*&\s*control|c2\s*server/gi, severity: "critical", description: "Botnet reference" },
          { regex: /(?:\/dev\/random|\/dev\/urandom|RtlGenRandom|CryptGenRandom|rand|srand)/gi, severity: "medium", description: "Random data generation" },
          { regex: /(?:CreateMutex|OpenMutex).*?[\w-]{20,}/gi, severity: "high", description: "Mutex creation (persistence)" },
          { regex: /RegSetValue|RegCreateKey|AddMonitor/gi, severity: "high", description: "Registry/system modification" },
          { regex: /CreateService|OpenService|StartService/gi, severity: "high", description: "Service manipulation" },
          { regex: /WinExec|ShellExecute|ShellExecuteEx/gi, severity: "critical", description: "Program execution API" },
          { regex: /strstr|strcpy|memcpy|malloc|memset/gi, severity: "medium", description: "Memory manipulation function" },
          { regex: /URLDownloadToFile|DownloadFile|XMLHTTP/gi, severity: "high", description: "File download function" }
        ],
        description: "Detection of payload signatures including obfuscated shellcode, reverse shells, and dynamic code execution."
      },
      jbig2Trick: {
        patterns: [
          { 
            regex: /(?=.*\/Filter\s*\/JBIG2Decode)(?=.*\/Height\s+1)(?=.*\/Width\s+(\d{3,}))/gi, 
            severity: "critical",
            description: "JBIG2 trick with abnormal dimensions" 
          },
          {
            regex: /\/JBIG2Decode.*?\/Width\s+(\d+).*?\/Height\s+(\d+)/gi,
            severity: "high", 
            description: "JBIG2 image with suspicious dimensions"
          },
          {
            regex: /\/JBIG2Globals/gi,
            severity: "medium",
            description: "JBIG2 globals dictionary"
          }
        ],
        description: "Detection of malicious JBIG2 trick using abnormal image dimensions (e.g. width > 100px and height = 1)."
      },
      fileInclusionAttacks: {
        patterns: [
          { regex: /require\s*\(\s*['"][^'"]+\$.*?['"]/, severity: "critical", description: "PHP dynamic file inclusion" },
          { regex: /include\s*\(\s*['"][^'"]+\$.*?['"]/, severity: "critical", description: "PHP dynamic file inclusion" },
          { regex: /import\s+.*?\s+from\s+['"][^'"]+\$.*?['"]/, severity: "critical", description: "JavaScript dynamic import" },
          { regex: /load\s*\(\s*['"][^'"]+\$.*?['"]/, severity: "high", description: "Dynamic loading" },
          { regex: /\.\.\//g, severity: "high", description: "Directory traversal" },
          { regex: /%(25)+/, severity: "high", description: "Double URL encoding" },
          { regex: /\.\.%2f/gi, severity: "high", description: "Encoded directory traversal" },
          { regex: /file:\/\/\/etc\/passwd/gi, severity: "critical", description: "Unix password file access" },
          { regex: /file:\/\/\/c:\\/gi, severity: "critical", description: "Windows root directory access" },
          { regex: /php:\/\/filter\/|php:\/\/input/gi, severity: "critical", description: "PHP stream wrapper" },
          { regex: /data:text\/html/gi, severity: "high", description: "Data URI HTML content" },
          { regex: /jar:file:/gi, severity: "high", description: "JAR protocol exploitation" },
          { regex: /file:\/\/\/\/\/\//gi, severity: "high", description: "UNC path (file://////)" },
          { regex: /gopher:\/\/|dict:\/\//gi, severity: "high", description: "Unusual protocol" }
        ],
        description: "Detection of file inclusion vulnerabilities, directory traversal attempts, and protocol-based attacks."
      },
      sensitiveInformation: {
        patterns: [
          { regex: /\b(?:password|passwd|pwd)\s*[:=]\s*['"][^'"]{3,}['"]/, severity: "critical", description: "Password in plaintext" },
          { regex: /\b(?:apikey|api_key|api[-_]?token|access[-_]?token)\s*[:=]\s*['"][^'"]{3,}['"]/, severity: "critical", description: "API key or token" },
          { regex: /\b(?:secret|private[-_]?key)\s*[:=]\s*['"][^'"]{3,}['"]/, severity: "critical", description: "Secret or private key" },
          { regex: /-----BEGIN\s+(?:RSA|DSA|EC|PGP|OPENSSH)\s+PRIVATE\s+KEY-----/, severity: "critical", description: "Private key block" },
          { regex: /\b(?:aws_access_key_id|aws_secret_access_key)\s*[:=]/, severity: "critical", description: "AWS credentials" },
          { regex: /\b(?:jdbc:|mongodb:\/\/|redis:\/\/|postgres:\/\/)([^:]+):([^@]+)@/, severity: "critical", description: "Database connection string" },
          { regex: /\b(?:\d{3}-\d{2}-\d{4})/, severity: "high", description: "US Social Security Number" },
          { regex: /\b(?:\d{4}-\d{4}-\d{4}-\d{4}|\d{4}\s\d{4}\s\d{4}\s\d{4}|\d{16})/, severity: "high", description: "Credit card number" },
          { regex: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/, severity: "medium", description: "Email address" },
          { regex: /\bip\s*[:=]\s*['"](\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})['"]/, severity: "medium", description: "IP address assignment" },
          { regex: /\b(?:account|acct)[-_]?(?:number|num|no)\s*[:=]\s*['"][^'"]{3,}['"]/, severity: "high", description: "Account number" },
          { regex: /\b(?:authorization|auth)[-_]?header\s*[:=]\s*['"]Bearer\s+[^'"]+['"]/, severity: "critical", description: "Bearer token" },
          { regex: /-----BEGIN\s+CERTIFICATE-----/, severity: "medium", description: "Certificate data" },
          { regex: /eyJ[A-Za-z0-9\-_]+\.eyJ[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+/, severity: "high", description: "JWT token" },
          { regex: /github_pat_[A-Za-z0-9_]{82}/, severity: "critical", description: "GitHub Personal Access Token" },
          { regex: /xox[baprs]-[0-9]{12}-[0-9]{12}-[0-9]{12}-[a-zA-Z0-9]{32}/, severity: "critical", description: "Slack token" }
        ],
        description: "Detection of exposed sensitive information like credentials, API keys, tokens, and personally identifiable information."
      },
      cryptographicOperations: {
        patterns: [
          { regex: /\bcrypto\..+?\(|\bcipher\..+?\(|\bhash\..+?\(/gi, severity: "medium", description: "Cryptographic operation" },
          { regex: /\.encrypt\(|\.decrypt\(/gi, severity: "medium", description: "Encryption/decryption method" },
          { regex: /AES\.|Rijndael\.|RSA\.|DSA\.|ECDSA\.|TripleDES/gi, severity: "medium", description: "Cryptographic algorithm" },
          { regex: /MD5\(|SHA1\(|SHA256\(|SHA512\(/gi, severity: "medium", description: "Hash function call" },
          { regex: /CryptoJS\.[A-Za-z]+\(/gi, severity: "medium", description: "CryptoJS usage" },
          { regex: /new\s+(?:AesManaged|AesCryptoServiceProvider|RijndaelManaged|RSACryptoServiceProvider)/gi, severity: "medium", description: ".NET cryptography" },
          { regex: /PyCrypto|Crypto\.Cipher|Crypto\.Hash|Crypto\.PublicKey/gi, severity: "medium", description: "Python cryptography" },
          { regex: /javax\.crypto\.|java\.security\.|java\.security\.MessageDigest/gi, severity: "medium", description: "Java cryptography" },
          { regex: /OpenSSL_encrypt|EVP_EncryptInit|EVP_DecryptInit/gi, severity: "medium", description: "OpenSSL functions" },
          { regex: /bcrypt\.hash|bcrypt\.compare|scrypt\(/gi, severity: "medium", description: "Password hashing" },
          { regex: /PBKDF2|argon2/gi, severity: "medium", description: "Key derivation function" },
          { regex: /generateKey|generateKeyPair|importKey|deriveKey/gi, severity: "medium", description: "Key generation/management" },
          { regex: /CBC|ECB|GCM|CTR/gi, severity: "low", description: "Encryption mode" },
          { regex: /encodeBase64|decodeBase64|Base64\.encode|Base64\.decode/gi, severity: "low", description: "Base64 encoding/decoding" }
        ],
        description: "Detection of cryptographic operations, potentially used for payload decryption or sensitive data handling."
      },
      anomalousPatterns: {
        patterns: [
          { regex: /\b(\w+)(?:["'`]){0,1}\s*\+\s*(?:["'`]){0,1}(\w+)\b/gi, severity: "medium", description: "String concatenation" },
          { regex: /\[["'](\w+)["']\]\s*\(/gi, severity: "high", description: "Bracket notation function call" },
          { regex: /\(\s*['"]\s*\+/gi, severity: "high", description: "Concatenated execution" },
          { regex: /\b(?:0[xX][0-9a-fA-F]+){5,}/gi, severity: "medium", description: "Multiple hex values" },
          { regex: /new\s+ActiveXObject\(/gi, severity: "high", description: "ActiveX instantiation" },
          { regex: /\(\s*\+\s*\+\s*\!/gi, severity: "high", description: "Obfuscated type conversion" },
          { regex: /\(\s*\+\s*[\[{!]/gi, severity: "high", description: "JavaScript type coercion" },
          { regex: /(\w+)\["([^"]+)"\]\["([^"]+)"\]/gi, severity: "medium", description: "Nested property access" },
          { regex: /\((['"]).*?\1\)\.constructor/gi, severity: "high", description: "Constructor property access" },
          { regex: /\[[^\]]+\]\s*\[[^\]]+\]/gi, severity: "medium", description: "Multiple bracket notation" },
          { regex: /\b(this|self|window|document|global)\s*\[\s*['"](\w+)['"]\s*\]/gi, severity: "medium", description: "Dynamic global property access" },
          { regex: /\b(Object|Array|String|RegExp|Function|Boolean|Number)\.prototype\.(.*?)\s*=/gi, severity: "high", description: "Prototype modification" },
          { regex: /function\s*\(\s*\)\s*\{\s*\[native code\]\s*\}/gi, severity: "high", description: "Native code function spoofing" },
          { regex: /arguments\.callee/gi, severity: "medium", description: "Arguments callee reference" },
          { regex: /data:(?!image\/)[^;]+;base64,/gi, severity: "high", description: "Non-image Data URI" },
          { regex: /\b(fso|wsh|wscript)\.([a-zA-Z]+)\(/gi, severity: "high", description: "Windows scripting host object" },
          { regex: /\bfreeze\s*\(|\bdefineProperty\s*\(/gi, severity: "medium", description: "Object manipulation" },
          { regex: /\bescape\s*\(|\bunescape\s*\(/gi, severity: "medium", description: "URL encoding/decoding" },
          { regex: /\\\\r|\\\\n|\\\\t/gi, severity: "low", description: "Double-escaped whitespace" },
          { regex: /String\.prototype\.replace\.call\(/gi, severity: "high", description: "String prototype method borrowing" }
        ],
        description: "Detection of unusual code patterns that often indicate obfuscation, evasion, or exploitation techniques."
      }
    };
    
    // ==============================================
    // ENHANCED PDF ANALYZER CLASS
    // ==============================================
    
    class PDFAnalyzer {
      constructor() {
        this.scanLevel = "standard"; // "quick", "standard", "deep", or "forensic"
        this.results = {
          metadata: {},
          security: {},
          structure: {},
          text: "",
          deepAnnotations: [],
          rawScanFindings: [],
          javascriptContent: [],
          networkReferences: [],
          objectTypes: {},
          structureTree: {},
          stats: { threatScore: 0, totalIssues: 0, criticalIssues: 0, highIssues: 0, mediumIssues: 0, lowIssues: 0 },
          intelligentInsights: [],
          fileProperties: {},
          recommendations: []
        };
      }
      
      setScanLevel(level) {
        this.scanLevel = level;
      }
    
      async analyzePDF(arrayBuffer, fileName) {
        try {
          this.updateProgress(0, "Initializing analysis...");
          this.updateTaskProgress("structure", 0, "Waiting...");
          this.updateTaskProgress("content", 0, "Waiting...");
          this.updateTaskProgress("security", 0, "Waiting...");
          this.updateTaskProgress("threat", 0, "Waiting...");
          
          // Store file properties
          const fileSize = arrayBuffer.byteLength;
          this.results.fileProperties = {
            name: fileName || "Unknown",
            size: fileSize,
            sizeFormatted: this.formatFileSize(fileSize),
            scanTimestamp: new Date().toISOString(),
            scanLevel: this.scanLevel
          };
          
          // Create a fresh copy of the ArrayBuffer to avoid detachment errors
          const typedArray = new Uint8Array(arrayBuffer);
          const freshBuffer = typedArray.slice(0).buffer;
          
          // Initial raw data scan
          this.updateProgress(5, "Performing initial raw data analysis...");
          this.updatePhase("Raw binary analysis");
          const rawScanReport = this.scanRawPDFData(freshBuffer);
          this.results.rawScanFindings = rawScanReport.findings;
          this.results.fileHash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(freshBuffer)).toString();
          
          // Attempt to parse the PDF
          let pdf;
          try {
            this.updateProgress(10, "Loading PDF document...");
            pdf = await pdfjsLib.getDocument({ data: freshBuffer }).promise;
          } catch (pdfError) {
            console.warn("PDF.js parsing error: " + pdfError.message);
            this.results.error = pdfError.message;
            this.results.metadata = { 
              version: "Unknown", 
              pageCount: 0, 
              encrypted: false, 
              error: pdfError.message
            };
            
            // Still perform raw analysis
            this.updateProgress(20, "PDF parsing failed. Analyzing raw content...");
            this.results.text = new TextDecoder().decode(new Uint8Array(freshBuffer).slice(0, 100000));
            
            this.updateProgress(60, "Performing security analysis on raw data...");
            this.updateTaskProgress("security", 50, "Analyzing raw data...");
            await this.performSecurityAnalysis();
            
            this.updateProgress(80, "Analyzing file integrity issues...");
            this.updateTaskProgress("threat", 50, "Calculating threat score...");
            
            // Add corruption insight
            this.results.intelligentInsights.push({
              type: "corruption",
              title: "PDF Parsing Error",
              description: `The PDF structure appears to be corrupted or malformed: ${pdfError.message}`,
              severity: "high"
            });
            
            this.calculateThreatScore();
            this.generateRecommendations();
            
            this.updateTaskProgress("security", 100, "Complete");
            this.updateTaskProgress("threat", 100, "Complete");
            this.updateProgress(100, "Analysis complete (raw scan only)");
            
            return this.results;
          }
          
          // Document successfully parsed - perform full analysis
          this.updateProgress(15, "PDF structure validated.");
          this.updateTaskProgress("structure", 10, "Extracting metadata...");
          
          // Extract metadata
          this.updateProgress(20, "Extracting metadata...");
          this.updatePhase("Metadata extraction");
          await this.extractMetadata(pdf);
          this.updateTaskProgress("structure", 30, "Metadata extracted");
          
          // Process document structure
          this.updateProgress(30, "Analyzing PDF structure...");
          this.updatePhase("Structure analysis");
          await this.analyzePDFStructure(pdf);
          this.updateTaskProgress("structure", 70, "Structure analyzed");
          
          // Extract content based on scan level
          this.updateProgress(40, "Extracting document content...");
          this.updatePhase("Content extraction");
          this.updateTaskProgress("content", 30, "Extracting text...");
          await this.extractContent(pdf);
          this.updateTaskProgress("content", 70, "Content extracted");
          
          // Deep scan annotations and actions
          this.updateProgress(60, "Scanning annotations and actions...");
          this.updatePhase("Object analysis");
          this.updateTaskProgress("content", 80, "Scanning annotations...");
          await this.deepScanAnnotations(pdf);
          this.updateTaskProgress("content", 100, "Complete");
          
          // Extract JavaScript content
          if (this.scanLevel !== "quick") {
            this.updateProgress(70, "Extracting and analyzing JavaScript...");
            this.updatePhase("JavaScript analysis");
            this.updateTaskProgress("security", 30, "Analyzing scripts...");
            await this.extractJavaScriptContent(pdf);
          }
          
          // Extract network references
          this.updateProgress(75, "Analyzing network references...");
          this.updatePhase("Network analysis");
          this.updateTaskProgress("security", 50, "Scanning for URLs...");
          await this.extractNetworkReferences();
          
          // Perform comprehensive security analysis
          this.updateProgress(80, "Performing security analysis...");
          this.updatePhase("Security scanning");
          this.updateTaskProgress("security", 70, "Pattern matching...");
          await this.performSecurityAnalysis();
          this.updateTaskProgress("security", 100, "Complete");
          
          // Generate threat score and intelligent insights
          this.updateProgress(90, "Analyzing threats and generating insights...");
          this.updatePhase("Threat analysis");
          this.updateTaskProgress("threat", 50, "Calculating scores...");
          this.calculateThreatScore();
          this.generateIntelligentInsights();
          
          // Generate recommendations
          this.updateProgress(95, "Generating security recommendations...");
          this.updateTaskProgress("threat", 80, "Creating recommendations...");
          this.generateRecommendations();
          this.updateTaskProgress("threat", 100, "Complete");
          
          // Complete analysis
          this.updateProgress(100, "Analysis complete");
          this.updatePhase("Complete");
          
          return this.results;
        } catch (error) {
          console.error("Analysis error:", error);
          this.results.error = error.message;
          throw new Error(`PDF Analysis failed: ${error.message}`);
        }
      }
      
      scanRawPDFData(arrayBuffer) {
        const findings = [];
        const rawBytes = new Uint8Array(arrayBuffer);
        const textData = new TextDecoder().decode(rawBytes.slice(0, Math.min(rawBytes.length, 100000)));
        
        // Check for PDF header
        const hasPdfHeader = textData.startsWith("%PDF-");
        if (!hasPdfHeader) {
          findings.push({ 
            type: "Invalid PDF Header", 
            message: "File does not begin with %PDF- header", 
            severity: "critical" 
          });
        }
        
        // Check for EOF marker
        const hasEOFMarker = textData.includes("%%EOF");
        if (!hasEOFMarker) {
          findings.push({ 
            type: "Missing EOF Marker", 
            message: "PDF does not contain %%EOF marker", 
            severity: "medium" 
          });
        }
        
        // Look for embedded files
        const embedMatch = textData.match(/\/EmbeddedFile|\/Filespec/gi);
        if (embedMatch) {
          findings.push({ 
            type: "Embedded Files", 
            message: `Detected ${embedMatch.length} reference(s) to embedded files`, 
            severity: "high" 
          });
        }
        
        // Look for XFA forms
        const xfaMatch = textData.match(/\/XFA/gi);
        if (xfaMatch) {
          findings.push({ 
            type: "XFA Forms", 
            message: `Detected ${xfaMatch.length} reference(s) to XFA (XML Forms)`, 
            severity: "medium" 
          });
        }
        
        // Look for JavaScript
        const jsMatch = textData.match(/\/JavaScript|\/JS/gi);
        if (jsMatch) {
          findings.push({ 
            type: "JavaScript", 
            message: `Detected ${jsMatch.length} reference(s) to JavaScript`, 
            severity: "high" 
          });
        }
        
        // Look for auto-open actions
        const actionMatch = textData.match(/\/OpenAction|\/AA/gi);
        if (actionMatch) {
          findings.push({ 
            type: "Automatic Actions", 
            message: `Detected ${actionMatch.length} reference(s) to automatic actions`, 
            severity: "high" 
          });
        }
        
        // Look for Launch actions
        const launchMatch = textData.match(/\/Launch/gi);
        if (launchMatch) {
          findings.push({ 
            type: "Launch Actions", 
            message: `Detected ${launchMatch.length} reference(s) to Launch actions`, 
            severity: "critical" 
          });
        }
        
        // Check for file signatures inside PDF (polyglot files)
        const signatureMap = [
          { name: "ZIP/Office document", regex: /\x50\x4B\x03\x04/g, severity: "high" },
          { name: "OLE2/MS Office document", regex: /\xD0\xCF\x11\xE0/g, severity: "high" },
          { name: "Windows PE executable", regex: /\x4D\x5A[\x00-\xFF]{64,}/g, severity: "critical" },
          { name: "JPEG image", regex: /\xFF\xD8\xFF/g, severity: "medium" },
          { name: "PNG image", regex: /\x89\x50\x4E\x47\x0D\x0A\x1A\x0A/g, severity: "medium" },
          { name: "GIF image", regex: /\x47\x49\x46\x38[79]\x61/g, severity: "medium" },
          { name: "7z archive", regex: /\x37\x7A\xBC\xAF\x27\x1C/g, severity: "high" },
          { name: "RAR archive", regex: /\x52\x61\x72\x21\x1A\x07/g, severity: "high" },
          { name: "ELF executable", regex: /\x7F\x45\x4C\x46/g, severity: "critical" }
        ];
        
        for (const sig of signatureMap) {
          let matchFound = false;
          // Convert hex pattern to binary for direct comparison
          const pattern = sig.regex.source;
          const hexChars = pattern.match(/\\x([0-9A-Fa-f]{2})/g);
          
          if (hexChars && hexChars.length > 0) {
            const searchBytes = new Uint8Array(hexChars.length);
            for (let i = 0; i < hexChars.length; i++) {
              searchBytes[i] = parseInt(hexChars[i].slice(2), 16);
            }
            
            // Search the raw bytes for this pattern
            for (let i = 0; i < rawBytes.length - searchBytes.length; i++) {
              let found = true;
              for (let j = 0; j < searchBytes.length; j++) {
                if (rawBytes[i + j] !== searchBytes[j]) {
                  found = false;
                  break;
                }
              }
              if (found) {
                matchFound = true;
                break;
              }
            }
          } else if (sig.regex.test(rawBytes)) {
            matchFound = true;
          }
          
          if (matchFound) {
            findings.push({ 
              type: "File Signature", 
              message: `Detected ${sig.name} signature within PDF data`, 
              severity: sig.severity 
            });
          }
        }
        
        // Check for incremental updates (multiple EOF markers)
        const eofMatches = textData.match(/%%EOF/g);
        if (eofMatches && eofMatches.length > 1) {
          findings.push({ 
            type: "Incremental Updates", 
            message: `PDF contains ${eofMatches.length} EOF markers, indicating multiple updates`, 
            severity: "medium" 
          });
        }
        
        // Check for encryption
        const encryptMatch = textData.match(/\/Encrypt/gi);
        if (encryptMatch) {
          findings.push({ 
            type: "Encryption", 
            message: "PDF contains encryption", 
            severity: "medium" 
          });
        }
        
        return { findings };
      }
    
      async extractMetadata(pdf) {
        try {
          const metadata = await pdf.getMetadata();
          
          // Process info dictionary
          this.results.metadata = {
            version: pdf.pdfInfo?.version || 'Unknown',
            pageCount: pdf.numPages,
            encrypted: !!pdf.pdfInfo?.encrypted,
            ...metadata.info
          };
          
          // Process metadata stream (XMP)
          if (metadata.metadata) {
            try {
              const xmp = metadata.metadata.getRaw();
              if (xmp) {
                this.results.metadata.xmp = xmp;
                
                // Extract additional XMP metadata
                const creatorToolMatch = xmp.match(/<xmp:CreatorTool>(.*?)<\/xmp:CreatorTool>/);
                if (creatorToolMatch) {
                  this.results.metadata.creatorTool = creatorToolMatch[1];
                }
                
                const createDateMatch = xmp.match(/<xmp:CreateDate>(.*?)<\/xmp:CreateDate>/);
                if (createDateMatch) {
                  this.results.metadata.createDate = createDateMatch[1];
                }
                
                const modifyDateMatch = xmp.match(/<xmp:ModifyDate>(.*?)<\/xmp:ModifyDate>/);
                if (modifyDateMatch) {
                  this.results.metadata.modifyDate = modifyDateMatch[1];
                }
              }
            } catch (xmpError) {
              console.warn('XMP metadata extraction error:', xmpError);
            }
          }
          
          // Add extended metadata analysis
          this.analyzeExtendedMetadata();
          
        } catch (error) {
          console.warn('Metadata extraction error:', error);
          this.results.metadata = { 
            version: 'Unknown', 
            pageCount: pdf.numPages, 
            encrypted: false, 
            error: 'Failed to extract metadata' 
          };
        }
      }
      
      analyzeExtendedMetadata() {
        const meta = this.results.metadata;
        
        // Analyze creation and modification dates
        if (meta.CreationDate) {
          try {
            const creationDate = this.parsePdfDate(meta.CreationDate);
            meta.creationDateFormatted = creationDate.toISOString();
          } catch (e) {
            console.warn("Failed to parse creation date", e);
          }
        }
        
        if (meta.ModDate) {
          try {
            const modDate = this.parsePdfDate(meta.ModDate);
            meta.modDateFormatted = modDate.toISOString();
          } catch (e) {
            console.warn("Failed to parse modification date", e);
          }
        }
        
        // Analyze producer/creator tools
        if (meta.Producer) {
          meta.producerAnalysis = this.analyzeCreatorSoftware(meta.Producer);
        }
        
        if (meta.Creator) {
          meta.creatorAnalysis = this.analyzeCreatorSoftware(meta.Creator);
        }
      }
      
      parsePdfDate(dateString) {
        // PDF date format: D:YYYYMMDDHHmmSSOHH'mm'
        if (!dateString.startsWith('D:')) {
          dateString = 'D:' + dateString;
        }
        
        let year = parseInt(dateString.substring(2, 6)) || 0;
        let month = parseInt(dateString.substring(6, 8)) || 1;
        let day = parseInt(dateString.substring(8, 10)) || 1;
        let hour = parseInt(dateString.substring(10, 12)) || 0;
        let minute = parseInt(dateString.substring(12, 14)) || 0;
        let second = parseInt(dateString.substring(14, 16)) || 0;
        
        // Handle timezone
        let offsetHours = 0;
        let offsetMinutes = 0;
        
        if (dateString.length > 16) {
          const tzSign = dateString.substring(16, 17);
          if (tzSign === '+' || tzSign === '-' || tzSign === 'Z') {
            if (tzSign === '+' || tzSign === '-') {
              offsetHours = parseInt(dateString.substring(17, 19)) || 0;
              offsetMinutes = parseInt(dateString.substring(20, 22)) || 0;
              if (tzSign === '-') {
                offsetHours = -offsetHours;
                offsetMinutes = -offsetMinutes;
              }
            }
          }
        }
        
        const date = new Date(Date.UTC(year, month - 1, day, hour, minute, second));
        const timezoneOffset = (offsetHours * 60 + offsetMinutes) * 60 * 1000;
        return new Date(date.getTime() - timezoneOffset);
      }
      
      analyzeCreatorSoftware(creatorString) {
        if (!creatorString) return { name: "Unknown", version: "Unknown" };
        
        // Common PDF creator patterns
        const patterns = [
          { regex: /Adobe.+?(\d+\.\d+)/i, name: "Adobe Acrobat", trust: "high" },
          { regex: /Microsoft.+?(\d+\.\d+)/i, name: "Microsoft Office", trust: "high" },
          { regex: /LibreOffice.+?(\d+\.\d+)/i, name: "LibreOffice", trust: "high" },
          { regex: /OpenOffice.+?(\d+\.\d+)/i, name: "OpenOffice", trust: "high" },
          { regex: /pdfTeX.+?(\d+\.\d+)/i, name: "pdfTeX", trust: "high" },
          { regex: /LaTeX.+?(\d+\.\d+)/i, name: "LaTeX", trust: "high" },
          { regex: /iText.+?(\d+\.\d+)/i, name: "iText", trust: "high" },
          { regex: /Foxit.+?(\d+\.\d+)/i, name: "Foxit PDF", trust: "high" },
          { regex: /Nitro.+?(\d+\.\d+)/i, name: "Nitro PDF", trust: "high" },
          { regex: /PDFsharp.+?(\d+\.\d+)/i, name: "PDFsharp", trust: "high" },
          { regex: /Ghostscript.+?(\d+\.\d+)/i, name: "Ghostscript", trust: "high" },
          { regex: /pdftk.+?(\d+\.\d+)/i, name: "PDFtk", trust: "high" },
          { regex: /LEADTOOLS.+?(\d+\.\d+)/i, name: "LEADTOOLS", trust: "medium" },
          { regex: /pdf995/i, name: "PDF995", trust: "medium" },
          { regex: /dompdf.+?(\d+\.\d+)/i, name: "dompdf", trust: "medium" },
          { regex: /TCPDF.+?(\d+\.\d+)/i, name: "TCPDF", trust: "medium" },
          { regex: /FPDF.+?(\d+\.\d+)/i, name: "FPDF", trust: "medium" },
          { regex: /mPDF.+?(\d+\.\d+)/i, name: "mPDF", trust: "medium" },
          { regex: /wkhtmltopdf.+?(\d+\.\d+)/i, name: "wkhtmltopdf", trust: "medium" },
          { regex: /Scribus.+?(\d+\.\d+)/i, name: "Scribus", trust: "medium" },
          { regex: /WeasyPrint.+?(\d+\.\d+)/i, name: "WeasyPrint", trust: "medium" },
          { regex: /cairo.+?(\d+\.\d+)/i, name: "Cairo", trust: "medium" },
          { regex: /PhantomJS.+?(\d+\.\d+)/i, name: "PhantomJS", trust: "medium" },
          { regex: /Prince.+?(\d+\.\d+)/i, name: "Prince XML", trust: "medium" },
          { regex: /QuarkXPress.+?(\d+\.\d+)/i, name: "QuarkXPress", trust: "medium" },
          { regex: /PDFCreator.+?(\d+\.\d+)/i, name: "PDFCreator", trust: "medium" },
          { regex: /PDFlib.+?(\d+\.\d+)/i, name: "PDFlib", trust: "medium" },
          { regex: /unknown/i, name: "Unknown Tool", trust: "low" },
          { regex: /[a-zA-Z0-9]{32,}/i, name: "Suspicious String", trust: "very low" }
        ];
        
        for (const pattern of patterns) {
          const match = creatorString.match(pattern.regex);
          if (match) {
            return {
              name: pattern.name,
              version: match[1] || "Unknown",
              trust: pattern.trust,
              full: creatorString
            };
          }
        }
        
        // Default generic analysis
        return {
          name: "Unknown Tool",
          version: "Unknown",
          trust: "medium",
          full: creatorString
        };
      }
    
      async analyzePDFStructure(pdf) {
        this.results.structure = { 
          pages: [], 
          annotations: [], 
          forms: [],
          actions: [],
          javascript: [],
          documentRoot: {}
        };
        
        // Get document-level structure information
        try {
          const documentInfo = {
            pageCount: pdf.numPages,
            hasXfa: false,
            hasAcroform: false,
            hasStructTreeRoot: false
          };
          
          this.results.structure.documentInfo = documentInfo;
          
          // Analyze individual pages
          for (let i = 1; i <= pdf.numPages; i++) {
            this.updateTaskProgress("structure", 30 + Math.floor(40 * (i / pdf.numPages)), 
              `Analyzing page ${i} of ${pdf.numPages}...`);
            
            try {
              const page = await pdf.getPage(i);
              
              // Get page annotations
              const annotations = await page.getAnnotations();
              this.results.structure.annotations.push(...annotations.map(a => ({...a, pageNumber: i})));
              
              // Build structure information for this page
              const pageStructure = {
                pageNumber: i,
                width: Math.round(page.view[2]),
                height: Math.round(page.view[3]),
                hasContent: true,
                rotation: page.rotate || 0,
                annotations: annotations.length,
                hasJavaScript: annotations.some(a => a.subtype === 'JavaScript' || a.subtype === 'JS'),
                hasLinks: annotations.some(a => a.subtype === 'Link'),
                hasActions: annotations.some(a => a.actions && Object.keys(a.actions).length > 0),
                hasFormFields: annotations.some(a => a.fieldType),
                hasEmbeddedFiles: annotations.some(a => a.subtype === 'FileAttachment')
              };
              
              // Track annotation types
              const annotationTypes = {};
              for (const ann of annotations) {
                annotationTypes[ann.subtype] = (annotationTypes[ann.subtype] || 0) + 1;
              }
              pageStructure.annotationTypes = annotationTypes;
              
              this.results.structure.pages.push(pageStructure);
            } catch (pageError) {
              console.warn(`Error analyzing page ${i}:`, pageError);
              this.results.structure.pages.push({
                pageNumber: i,
                error: pageError.message,
                hasContent: false
              });
            }
          }
          
          // Analyze PDF objects and their hierarchy (if in deep scan mode)
          if (this.scanLevel === "deep" || this.scanLevel === "forensic") {
            this.updateTaskProgress("structure", 80, "Analyzing document object hierarchy...");
            await this.analyzeObjectHierarchy(pdf);
          }
          
        } catch (error) {
          console.warn('Structure analysis error:', error);
          this.results.structure.error = error.message;
        }
      }
      
      async analyzeObjectHierarchy(pdf) {
        // This would analyze the PDF objects hierarchy
        // This is a placeholder for advanced structure analysis
        this.results.structure.objectHierarchy = {
          type: "Document",
          children: [
            {
              type: "Catalog",
              children: [
                {
                  type: "Pages",
                  children: this.results.structure.pages.map(page => ({
                    type: "Page",
                    id: page.pageNumber,
                    properties: {
                      width: page.width,
                      height: page.height,
                      rotation: page.rotation
                    },
                    children: [
                      {
                        type: "Annotations",
                        count: page.annotations
                      },
                      {
                        type: "Content",
                        exists: page.hasContent
                      }
                    ]
                  }))
                }
              ]
            }
          ]
        };
      }
    
      async extractContent(pdf) {
        let text = "";
        const maxPages = (this.scanLevel === "quick") ? Math.min(3, pdf.numPages) : pdf.numPages;
        
        for (let i = 1; i <= maxPages; i++) {
          try {
            this.updateProgress(40 + Math.floor(15 * (i / maxPages)), 
              `Extracting text from page ${i} of ${maxPages}...`);
            
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const pageText = content.items.map(item => item.str).join(" ");
            
            text += pageText + "\n\n--- Page " + i + " ---\n\n";
            
            // For forensic scan, extract image data
            if (this.scanLevel === "forensic") {
              // This is a placeholder for image extraction in forensic mode
              // In a real implementation, this would extract and analyze images
            }
          } catch (error) {
            console.warn(`Error extracting text from page ${i}:`, error);
            text += `[Error extracting page ${i}: ${error.message}]\n\n`;
          }
        }
        
        this.results.text = text;
        
        // For quick scans, only extract a portion of text
        if (this.scanLevel === "quick" && text.length > 10000) {
          this.results.textSample = text.substring(0, 10000) + "...";
        } else {
          this.results.textSample = text;
        }
      }
    
      async deepScanAnnotations(pdf) {
        this.results.deepAnnotations = [];
        this.results.objectTypes = {
          annotations: 0,
          actions: 0,
          javascript: 0,
          links: 0,
          formFields: 0,
          embeddedFiles: 0
        };
        
        try {
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            
            // Get standard annotations
            const annotations = await page.getAnnotations({ intent: 'display' });
            
            for (const ann of annotations) {
              // Count by type
              this.results.objectTypes.annotations++;
              
              if (ann.subtype === 'Link') {
                this.results.objectTypes.links++;
              } else if (ann.fieldType) {
                this.results.objectTypes.formFields++;
              } else if (ann.subtype === 'FileAttachment') {
                this.results.objectTypes.embeddedFiles++;
              }
              
              // Check for actions
              if (ann.actions && Object.keys(ann.actions).length > 0) {
                this.results.objectTypes.actions++;
                
                // Check for JavaScript actions
                if (ann.actions.JS || ann.actions.JavaScript) {
                  this.results.objectTypes.javascript++;
                }
              }
              
              // Store details
              const details = {
                page: i,
                id: `${i}_${ann.id || Math.random().toString(36).substring(2, 10)}`,
                subtype: ann.subtype || "Unknown",
                fieldType: ann.fieldType || "",
                fieldName: ann.fieldName || "",
                url: ann.url || "",
                contents: ann.contents || "",
                rect: ann.rect || [],
                actions: {}
              };
              
              // Process actions
              if (ann.actions) {
                for (const [key, action] of Object.entries(ann.actions)) {
                  details.actions[key] = {
                    type: key,
                    value: typeof action === 'string' ? action : JSON.stringify(action)
                  };
                }
              }
              
              this.results.deepAnnotations.push(details);
            }
          }
        } catch (error) {
          console.warn('deepScanAnnotations error:', error);
          this.results.deepAnnotations.push({
            error: error.message
          });
        }
      }
      
      async extractJavaScriptContent(pdf) {
        this.results.javascriptContent = [];
        
        // Extract JavaScript from annotations we already collected
        for (const ann of this.results.deepAnnotations) {
          if (ann.actions && (ann.actions.JS || ann.actions.JavaScript)) {
            const jsContent = {
              source: `Annotation (Page ${ann.page}, ${ann.subtype})`,
              code: ann.actions.JS?.value || ann.actions.JavaScript?.value || "Unknown JS code",
              location: `Page ${ann.page}`
            };
            this.results.javascriptContent.push(jsContent);
          }
        }
        
        // Extract document-level JavaScript actions
        try {
          // This is a placeholder for document-level JavaScript extraction
          // In a real implementation, this would extract JavaScript from document actions
          // such as OpenAction, document.scripts, etc.
        } catch (error) {
          console.warn('JavaScript extraction error:', error);
        }
        
        // Analyze JavaScript for potential threats
        for (const js of this.results.javascriptContent) {
          js.analysis = this.analyzeJavaScript(js.code);
        }
      }
      
      analyzeJavaScript(code) {
        if (!code || typeof code !== 'string') return { risk: "unknown" };
        
        const analysis = {
          length: code.length,
          obfuscated: false,
          suspiciousAPIs: [],
          risk: "low",
          highlights: []
        };
        
        // Check for obfuscation indicators
        const obfuscationIndicators = [
          { pattern: /eval\s*\(/, name: "eval usage" },
          { pattern: /String\.fromCharCode\(/, name: "character code conversion" },
          { pattern: /unescape\s*\(/, name: "URL unescape" },
          { pattern: /\\x[0-9a-f]{2}/i, name: "hex escape sequences" },
          { pattern: /\\u[0-9a-f]{4}/i, name: "unicode escape sequences" },
          { pattern: /atob\s*\(/, name: "base64 decoding" },
          { pattern: /['"][^'"]*['"]\s*\+\s*['"][^'"]*['"]/, name: "string concatenation" }
        ];
        
        let obfuscationScore = 0;
        for (const indicator of obfuscationIndicators) {
          if (indicator.pattern.test(code)) {
            obfuscationScore++;
            analysis.highlights.push({
              type: "obfuscation",
              name: indicator.name,
              pattern: indicator.pattern.source
            });
          }
        }
        
        analysis.obfuscated = obfuscationScore >= 2;
        
        // Check for suspicious APIs
        const suspiciousAPIs = [
          { pattern: /app\.launchURL/, name: "URL launching" },
          { pattern: /app\.openDoc/, name: "document opening" },
          { pattern: /this\.submitForm/, name: "form submission" },
          { pattern: /doc\.write/, name: "document writing" },
          { pattern: /getURL/, name: "URL access" },
          { pattern: /XMLHttpRequest/, name: "XHR request" },
          { pattern: /fetch\s*\(/, name: "fetch API" },
          { pattern: /socket/, name: "socket usage" }
        ];
        
        for (const api of suspiciousAPIs) {
          if (api.pattern.test(code)) {
            analysis.suspiciousAPIs.push(api.name);
            analysis.highlights.push({
              type: "api",
              name: api.name,
              pattern: api.pattern.source
            });
          }
        }
        
        // Calculate risk level
        if (analysis.obfuscated && analysis.suspiciousAPIs.length > 0) {
          analysis.risk = "critical";
        } else if (analysis.obfuscated || analysis.suspiciousAPIs.length >= 2) {
          analysis.risk = "high";
        } else if (analysis.suspiciousAPIs.length === 1) {
          analysis.risk = "medium";
        } else {
          analysis.risk = "low";
        }
        
        return analysis;
      }
      
      async extractNetworkReferences() {
        this.results.networkReferences = [];
        
        // Helper to extract and deduplicate URLs
        const extractUrls = (text) => {
          const urlPattern = /(https?:\/\/|ftp:\/\/|file:\/\/\/)[^\s"'<>)]+/gi;
          const matches = text.match(urlPattern) || [];
          return [...new Set(matches)]; // Deduplicate
        };
        
        // Extract from text content
        const textUrls = extractUrls(this.results.text);
        for (const url of textUrls) {
          this.results.networkReferences.push({
            url,
            source: "Text content",
            risk: this.assessUrlRisk(url)
          });
        }
        
        // Extract from annotations (links)
        for (const ann of this.results.deepAnnotations) {
          if (ann.url) {
            this.results.networkReferences.push({
              url: ann.url,
              source: `Link annotation (Page ${ann.page})`,
              risk: this.assessUrlRisk(ann.url)
            });
          }
          
          // Check action URLs
          if (ann.actions) {
            for (const [key, action] of Object.entries(ann.actions)) {
              const actionValue = action.value || "";
              if (typeof actionValue === 'string') {
                const actionUrls = extractUrls(actionValue);
                for (const url of actionUrls) {
                  this.results.networkReferences.push({
                    url,
                    source: `${key} action (Page ${ann.page})`,
                    risk: this.assessUrlRisk(url)
                  });
                }
              }
            }
          }
        }
        
        // Extract from JavaScript
        for (const js of this.results.javascriptContent) {
          const jsUrls = extractUrls(js.code);
          for (const url of jsUrls) {
            this.results.networkReferences.push({
              url,
              source: `JavaScript (${js.source})`,
              risk: this.assessUrlRisk(url)
            });
          }
        }
        
        // Deduplicate based on URL
        const seenUrls = new Set();
        this.results.networkReferences = this.results.networkReferences.filter(ref => {
          if (seenUrls.has(ref.url)) return false;
          seenUrls.add(ref.url);
          return true;
        });
      }
      
      assessUrlRisk(url) {
        // Lowercase for comparison
        const lowerUrl = url.toLowerCase();
        
        // File URLs are high risk
        if (lowerUrl.startsWith('file:///')) {
          return { level: "high", reason: "Local file access" };
        }
        
        // Internal network or localhost
        if (lowerUrl.includes('127.0.0.1') || 
            lowerUrl.includes('localhost') || 
            lowerUrl.includes('192.168.') || 
            lowerUrl.includes('10.0.') || 
            lowerUrl.includes('172.16.') ||
            lowerUrl.includes('169.254.')) {
          return { level: "critical", reason: "Internal network access" };
        }
        
        // Executable file extensions
        if (lowerUrl.match(/\.(exe|dll|bat|cmd|ps1|vbs|js|sh)($|\?)/)) {
          return { level: "critical", reason: "Executable file reference" };
        }
        
        // Suspicious domain indicators
        const suspiciousDomains = ['evil', 'hack', 'malware', 'exploit', 'attack', 'phish', 'command', 'control', 'c2', 'exfil'];
        for (const term of suspiciousDomains) {
          if (lowerUrl.includes(term)) {
            return { level: "high", reason: `Suspicious domain term: ${term}` };
          }
        }
        
        // HTTP vs HTTPS
        if (lowerUrl.startsWith('http://')) {
          return { level: "medium", reason: "Insecure HTTP protocol" };
        }
        
        // Document extensions
        if (lowerUrl.match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx)($|\?)/)) {
          return { level: "medium", reason: "Document download link" };
        }
        
        // Default risk
        return { level: "low", reason: "Standard URL reference" };
      }
    
      async performSecurityAnalysis() {
        this.results.security = {};
        
        // Analyze different content sources for security patterns
        for (const [category, data] of Object.entries(securityPatterns)) {
          this.results.security[category] = [];
          
          // Scan text content
          const textMatches = this.matchPatterns(
            this.results.text, 
            data.patterns, 
            "Text Content"
          );
          
          // Scan annotations
          const annotationMatches = this.matchPatterns(
            this.results.deepAnnotations.map(obj => JSON.stringify(obj)).join("\n"),
            data.patterns,
            "Annotation"
          );
          
          // Scan raw findings
          const rawMatches = this.matchPatterns(
            this.results.rawScanFindings.map(item => JSON.stringify(item)).join("\n"),
            data.patterns,
            "Raw Data"
          );
          
          // Scan JavaScript content
          const jsMatches = this.matchPatterns(
            this.results.javascriptContent.map(js => js.code).join("\n"),
            data.patterns,
            "JavaScript"
          );
          
          // Scan metadata
          const metadataMatches = this.matchPatterns(
            JSON.stringify(this.results.metadata),
            data.patterns,
            "Metadata"
          );
          
          // Combine all findings
          this.results.security[category].push(...textMatches, ...annotationMatches, ...rawMatches, ...jsMatches, ...metadataMatches);
        }
      }
      
      matchPatterns(text, patterns, source) {
        const findings = [];
        
        if (!text || typeof text !== 'string') {
          return findings;
        }
        
        for (const { regex, severity, description } of patterns) {
          const matches = text.match(regex);
          if (matches && matches.length > 0) {
            // Extract context for each match
            const contextExamples = matches.slice(0, 3).map(match => {
              try {
                const matchIndex = text.indexOf(match);
                const startIndex = Math.max(0, matchIndex - 20);
                const endIndex = Math.min(text.length, matchIndex + match.length + 20);
                const prefix = startIndex > 0 ? '...' : '';
                const suffix = endIndex < text.length ? '...' : '';
                return prefix + text.substring(startIndex, endIndex) + suffix;
              } catch (e) {
                return match;
              }
            });
            
            findings.push({
              severity,
              matches: matches.length,
              description: description || "Pattern match",
              examples: matches.slice(0, 3),
              context: contextExamples,
              pattern: regex.source,
              source
            });
          }
        }
        
        return findings;
      }
      
      calculateThreatScore() {
        const severityWeights = { 
          critical: 100, 
          high: 70, 
          medium: 40, 
          low: 10,
          info: 0
        };
        
        let totalScore = 0;
        let totalIssues = 0;
        let criticalIssues = 0;
        let highIssues = 0;
        let mediumIssues = 0;
        let lowIssues = 0;
        
        // Process all security categories
        for (const category of Object.values(this.results.security)) {
          for (const finding of category) {
            const weight = severityWeights[finding.severity] || severityWeights.low;
            const matchCount = finding.matches || 0;
            
            totalScore += weight * matchCount;
            totalIssues += matchCount;
            
            // Count by severity
            if (finding.severity === 'critical') criticalIssues += matchCount;
            else if (finding.severity === 'high') highIssues += matchCount;
            else if (finding.severity === 'medium') mediumIssues += matchCount;
            else if (finding.severity === 'low') lowIssues += matchCount;
          }
        }
        
        // Process raw scan findings
        for (const finding of this.results.rawScanFindings) {
          const weight = severityWeights[finding.severity] || severityWeights.low;
          
          totalScore += weight;
          totalIssues += 1;
          
          // Count by severity
          if (finding.severity === 'critical') criticalIssues += 1;
          else if (finding.severity === 'high') highIssues += 1;
          else if (finding.severity === 'medium') mediumIssues += 1;
          else if (finding.severity === 'low') lowIssues += 1;
        }
        
        // Add penalties for specific risky combinations
        if (this.results.objectTypes) {
          // JavaScript + automatic actions is very risky
          if (this.results.objectTypes.javascript > 0 && 
              this.results.rawScanFindings.some(f => f.type === "Automatic Actions")) {
            totalScore += 100;
          }
          
          // Embedded files have risk
          if (this.results.objectTypes.embeddedFiles > 0) {
            totalScore += this.results.objectTypes.embeddedFiles * 30;
          }
        }
        
        // Calculate final threat score (0-100)
        let threatScore = totalIssues > 0 ? Math.min(100, Math.round(totalScore / Math.max(1, totalIssues))) : 0;
        
        // Ensure critical issues significantly impact score
        if (criticalIssues > 0) {
          threatScore = Math.max(threatScore, 70 + Math.min(30, criticalIssues * 5));
        }
        
        // Add penalty for raw parsing errors
        if (this.results.error) {
          threatScore = Math.max(threatScore, 60);
        }
        
        // Store result
        this.results.stats = { 
          threatScore, 
          totalIssues, 
          criticalIssues, 
          highIssues, 
          mediumIssues, 
          lowIssues 
        };
        
        // Add threat verdict
        if (threatScore >= 80) {
          this.results.stats.threatVerdict = "Critical Risk";
          this.results.stats.threatColor = "red";
        } else if (threatScore >= 60) {
          this.results.stats.threatVerdict = "High Risk";
          this.results.stats.threatColor = "orange";
        } else if (threatScore >= 40) {
          this.results.stats.threatVerdict = "Medium Risk";
          this.results.stats.threatColor = "yellow";
        } else if (threatScore >= 20) {
          this.results.stats.threatVerdict = "Low Risk";
          this.results.stats.threatColor = "blue";
        } else {
          this.results.stats.threatVerdict = "Minimal Risk";
          this.results.stats.threatColor = "green";
        }
      }
      
      generateIntelligentInsights() {
        const insights = [];
        
        // Check for JavaScript
        if (this.results.javascriptContent.length > 0) {
          insights.push({
            type: "javascript",
            title: "JavaScript Content Detected",
            description: `Found ${this.results.javascriptContent.length} JavaScript code blocks that could execute when the PDF is opened.`,
            severity: "high"
          });
        }
        
        // Check for OpenAction/AA
        if (this.results.rawScanFindings.some(f => f.type === "Automatic Actions")) {
          insights.push({
            type: "autoAction",
            title: "Automatic Actions Detected",
            description: "This PDF contains actions that execute automatically when the document is opened, which could be malicious.",
            severity: "high"
          });
        }
        
        // Check for Launch actions
        if (this.results.rawScanFindings.some(f => f.type === "Launch Actions")) {
          insights.push({
            type: "launch",
            title: "External Application Launch Actions",
            description: "This PDF contains actions that attempt to launch external applications, which is a serious security risk.",
            severity: "critical"
          });
        }
        
        // Check for embedded files
        if (this.results.rawScanFindings.some(f => f.type === "Embedded Files")) {
          insights.push({
            type: "embeddedFiles",
            title: "Embedded Files Detected",
            description: "This PDF has embedded files which could contain malicious content.",
            severity: "high"
          });
        }
        
        // Check for suspicious URLs
        const suspiciousUrls = this.results.networkReferences.filter(ref => 
          ref.risk.level === "critical" || ref.risk.level === "high"
        );
        
        if (suspiciousUrls.length > 0) {
          insights.push({
            type: "suspiciousUrls",
            title: "Suspicious URL References",
            description: `Found ${suspiciousUrls.length} suspicious URLs that may lead to malicious content.`,
            severity: "high",
            urls: suspiciousUrls.map(u => u.url).slice(0, 5)
          });
        }
        
        // Check for excessive annotations
        const annotationCount = this.results.deepAnnotations.length;
        if (annotationCount > 50) {
          insights.push({
            type: "excessiveAnnotations",
            title: "Excessive Annotations",
            description: `This PDF contains an unusually high number of annotations (${annotationCount}), which could indicate automated generation or obfuscation techniques.`,
            severity: "medium"
          });
        }
        
        // Check for inconsistent metadata
        if (this.results.metadata && this.results.metadata.Producer && this.results.metadata.Creator) {
          if (this.results.metadata.Producer.toLowerCase().includes("adobe") && 
              !this.results.metadata.Creator.toLowerCase().includes("adobe")) {
            insights.push({
              type: "inconsistentMetadata",
              title: "Inconsistent Creator Information",
              description: "The Producer and Creator metadata contain inconsistent information, which may indicate tampering.",
              severity: "medium"
            });
          }
        }
        
        // Check for obfuscated JavaScript
        const obfuscatedJs = this.results.javascriptContent.filter(js => js.analysis && js.analysis.obfuscated);
        if (obfuscatedJs.length > 0) {
          insights.push({
            type: "obfuscatedJs",
            title: "Obfuscated JavaScript Detected",
            description: `Found ${obfuscatedJs.length} JavaScript blocks that appear to be obfuscated, which is a common technique to hide malicious code.`,
            severity: "critical"
          });
        }
        
        // Form submission capabilities
        if (this.results.security.networkActivity && 
            this.results.security.networkActivity.some(f => f.pattern.includes("SubmitForm"))) {
          insights.push({
            type: "formSubmission",
            title: "Form Submission Capability",
            description: "This PDF contains form submission actions that could send data to external servers.",
            severity: "medium"
          });
        }
        
        // Suspicious patterns combined with JavaScript
        if (this.results.javascriptContent.length > 0 && 
            this.results.security.maliciousPatterns && 
            this.results.security.maliciousPatterns.length > 0) {
          insights.push({
            type: "maliciousPatterns",
            title: "Suspicious Code Patterns Detected",
            description: "The combination of JavaScript with suspicious code patterns increases the likelihood that this PDF is malicious.",
            severity: "critical"
          });
        }
        
        // XFA forms (complex attack surface)
        if (this.results.rawScanFindings.some(f => f.type === "XFA Forms")) {
          insights.push({
            type: "xfaForms",
            title: "XFA Forms Detected",
            description: "This PDF uses XML Forms Architecture (XFA), which expands the attack surface and may contain vulnerabilities.",
            severity: "medium"
          });
        }
        
        // Store insights
        this.results.intelligentInsights = insights;
      }
      
      generateRecommendations() {
        const recommendations = [];
        const threatScore = this.results.stats.threatScore;
        
        // High-level recommendation based on threat score
        if (threatScore >= 80) {
          recommendations.push({
            title: "Do Not Open This Document",
            description: "This PDF shows critical security risks and should not be opened. Isolate this file and consider reporting it to your security team.",
            category: "threat",
            priority: "critical"
          });
        } else if (threatScore >= 60) {
          recommendations.push({
            title: "Open Only in Isolated Environment",
            description: "This PDF has high security risks. Only open it in a sandboxed viewer with JavaScript disabled or in an isolated environment.",
            category: "threat",
            priority: "high"
          });
        } else if (threatScore >= 40) {
          recommendations.push({
            title: "Disable Interactive Features",
            description: "This PDF shows moderate security risks. Open with JavaScript disabled and avoid enabling interactive features.",
            category: "threat",
            priority: "medium"
          });
        }
        
        // Specific recommendations based on findings
        
        // JavaScript recommendations
        if (this.results.javascriptContent.length > 0) {
          recommendations.push({
            title: "Disable JavaScript in PDF Viewer",
            description: "This PDF contains JavaScript that could execute malicious code. Configure your PDF viewer to disable JavaScript execution.",
            category: "javascript",
            priority: "high"
          });
        }
        
        // External links recommendations
        if (this.results.networkReferences.length > 0) {
          recommendations.push({
            title: "Disable External Connections",
            description: "This PDF contains links to external resources. Use a PDF viewer that blocks external connections or use offline mode.",
            category: "network",
            priority: "medium"
          });
          
          // If suspicious URLs found
          if (this.results.networkReferences.some(ref => ref.risk.level === "critical" || ref.risk.level === "high")) {
            recommendations.push({
              title: "Verify External URLs",
              description: "This PDF contains suspicious URLs. Do not click any links and verify the legitimacy of any external resources before accessing them.",
              category: "network",
              priority: "high"
            });
          }
        }
        
        // Embedded files recommendations
        if (this.results.objectTypes.embeddedFiles > 0) {
          recommendations.push({
            title: "Do Not Extract Embedded Files",
            description: "This PDF contains embedded files that could be malicious. Do not extract or open these files.",
            category: "embeddedFiles",
            priority: "high"
          });
        }
        
        // Form recommendations
        if (this.results.objectTypes.formFields > 0) {
          recommendations.push({
            title: "Do Not Submit Forms",
            description: "This PDF contains form fields. Avoid submitting any information through these forms as they could send data to malicious servers.",
            category: "forms",
            priority: "medium"
          });
        }
        
        // Viewer recommendations
        recommendations.push({
          title: "Use a Secure PDF Viewer",
          description: "Use a modern PDF viewer with security features like sandboxing and exploit protection. Keep your viewer updated to the latest version.",
          category: "general",
          priority: "medium"
        });
        
        // Store recommendations
        this.results.recommendations = recommendations;
      }
      
      updateProgress(percent, message) {
        const event = new CustomEvent('analysisProgress', { 
          detail: { percent, message } 
        });
        window.dispatchEvent(event);
      }
      
      updatePhase(phase) {
        const event = new CustomEvent('analysisPhase', { 
          detail: { phase } 
        });
        window.dispatchEvent(event);
      }
      
      updateTaskProgress(taskId, percent, status) {
        const event = new CustomEvent('taskProgress', { 
          detail: { taskId, percent, status } 
        });
        window.dispatchEvent(event);
      }
      
      formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " bytes";
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
        else return (bytes / 1048576).toFixed(1) + " MB";
      }
    }
    
    // ==============================================
    // ENHANCED UI HANDLER CLASS
    // ==============================================
    
    class UIHandler {
      constructor() {
        this.analyzer = new PDFAnalyzer();
        this.scanLevel = "standard";
        this.setupEventListeners();
      }
      
      setupEventListeners() {
        // File selection
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('pdfInput');
        
        dropZone.addEventListener('dragover', (e) => { 
          e.preventDefault(); 
          dropZone.classList.add('dragover'); 
        });
        
        dropZone.addEventListener('dragleave', () => { 
          dropZone.classList.remove('dragover'); 
        });
        
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file?.type === 'application/pdf') { 
            fileInput.files = e.dataTransfer.files; 
            this.handleFileSelection(file); 
          } else { 
            this.showNotification('Please drop a PDF file', 'error'); 
          }
        });
        
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          if (file) this.handleFileSelection(file);
        });
        
        // Scan button and dropdown
        const scanButton = document.getElementById('scanButton');
        scanButton.addEventListener('click', () => {
          const scanLevelDropdown = document.getElementById('scanLevelDropdown');
          scanLevelDropdown.classList.toggle('hidden');
        });
        
        document.querySelectorAll('#scanLevelDropdown button').forEach(button => {
          button.addEventListener('click', () => {
            const level = button.dataset.level;
            this.scanLevel = level;
            document.getElementById('scanLevelDropdown').classList.add('hidden');
            
            const file = document.getElementById('pdfInput').files[0];
            if (file) {
              this.analyzer.setScanLevel(level);
              this.startScan(file);
            } else {
              this.showNotification('Please select a PDF file', 'warning');
            }
          });
        });
        
        // Hide dropdowns when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('#scanButton') && !e.target.closest('#scanLevelDropdown')) {
            document.getElementById('scanLevelDropdown').classList.add('hidden');
          }
          
          if (!e.target.closest('#exportOptionsButton') && !e.target.closest('#exportOptionsDropdown')) {
            document.getElementById('exportOptionsDropdown').classList.add('hidden');
          }
        });
        
        // Export options
        document.getElementById('exportOptionsButton').addEventListener('click', () => {
          document.getElementById('exportOptionsDropdown').classList.toggle('hidden');
        });
        
        document.getElementById('exportJSON').addEventListener('click', () => {
          this.exportReport('json');
          document.getElementById('exportOptionsDropdown').classList.add('hidden');
        });
        
        document.getElementById('exportPDF').addEventListener('click', () => {
          this.exportReport('pdf');
          document.getElementById('exportOptionsDropdown').classList.add('hidden');
        });
        
        document.getElementById('exportCSV').addEventListener('click', () => {
          this.exportReport('csv');
          document.getElementById('exportOptionsDropdown').classList.add('hidden');
        });
        
        document.getElementById('exportHTML').addEventListener('click', () => {
          this.exportReport('html');
          document.getElementById('exportOptionsDropdown').classList.add('hidden');
        });
        
        // Download report (legacy)
        document.getElementById('downloadReport').addEventListener('click', () => {
          this.exportReport('json');
        });
        
        // Tab navigation
        document.querySelectorAll('.tab-button').forEach(button => {
          button.addEventListener('click', () => this.switchTab(button.dataset.tab));
        });
        
        // Filter events
        document.getElementById('securitySeverityFilter')?.addEventListener('change', (e) => {
          this.filterSecurityResults(e.target.value);
        });
        
        document.getElementById('objectTypeFilter')?.addEventListener('change', (e) => {
          this.filterObjects(e.target.value);
        });
        
        document.getElementById('objectSearchInput')?.addEventListener('input', (e) => {
          this.searchObjects(e.target.value);
        });
        
        // Text expansion
        document.getElementById('expandTextBtn')?.addEventListener('click', () => {
          const textArea = document.getElementById('pdfText');
          if (textArea.value.endsWith('...')) {
            textArea.value = this.lastResults.text;
            document.getElementById('expandTextBtn').textContent = 'Show Less';
          } else {
            textArea.value = this.lastResults.textSample;
            document.getElementById('expandTextBtn').textContent = 'Show All';
          }
        });
        
        // Progress events
        window.addEventListener('analysisProgress', (e) => { 
          this.updateProgress(e.detail.percent, e.detail.message); 
        });
        
        window.addEventListener('analysisPhase', (e) => { 
          this.updatePhase(e.detail.phase); 
        });
        
        window.addEventListener('taskProgress', (e) => { 
          this.updateTaskProgress(e.detail.taskId, e.detail.percent, e.detail.status); 
        });
      }
      
      handleFileSelection(file) {
        const fileInput = document.getElementById('pdfInput');
        fileInput.files = new DataTransfer().files;
        fileInput.files = new DataTransfer().items.add(file).files;
        
        document.getElementById('progressContainer').classList.remove('hidden');
        document.getElementById('detailedProgress').classList.remove('hidden');
        document.getElementById('progressDetails').textContent = `File Selected: ${file.name} (${this.formatFileSize(file.size)})`;
        
        // Reset progress indicators
        this.updateProgress(0, "Ready to scan.");
        this.updatePhase("Waiting to start");
        this.updateTaskProgress("structure", 0, "Waiting...");
        this.updateTaskProgress("content", 0, "Waiting...");
        this.updateTaskProgress("security", 0, "Waiting...");
        this.updateTaskProgress("threat", 0, "Waiting...");
      }
      
      startScan(file) {
        const button = document.getElementById('scanButton');
        const spinner = document.getElementById('spinner');
        
        try {
          button.disabled = true;
          spinner.classList.remove('hidden');
          
          // Show scan level in UI
          document.getElementById('scanLevelDisplay').textContent = this.getScanLevelName(this.scanLevel);
          
          // Start analysis
          this.runAnalysis(file);
        } catch (error) {
          console.error(error);
          this.showNotification(`Error starting scan: ${error.message}`, 'error');
          button.disabled = false;
          spinner.classList.add('hidden');
        }
      }
      
      async runAnalysis(file) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const results = await this.analyzer.analyzePDF(arrayBuffer, file.name);
          this.lastResults = results;
          this.displayResults(results, file.name);
        } catch (error) {
          console.error(error);
          this.showNotification(`Error analyzing PDF: ${error.message}`, 'error');
        } finally {
          document.getElementById('scanButton').disabled = false;
          document.getElementById('spinner').classList.add('hidden');
        }
      }
      
      updateProgress(percent, message) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const progressDetails = document.getElementById('progressDetails');
        
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${Math.round(percent)}%`;
        progressText.textContent = "Scanning...";
        
        if (message) {
          progressDetails.textContent = message;
        }
      }
      
      updatePhase(phase) {
        const progressPhase = document.getElementById('progressPhase');
        if (progressPhase) {
          progressPhase.textContent = phase;
        }
      }
      
      updateTaskProgress(taskId, percent, status) {
        const taskItems = document.querySelectorAll('.task-item');
        
        let taskItem;
        if (taskId === "structure") taskItem = taskItems[0];
        else if (taskId === "content") taskItem = taskItems[1];
        else if (taskId === "security") taskItem = taskItems[2];
        else if (taskId === "threat") taskItem = taskItems[3];
        
        if (taskItem) {
          const progressBar = taskItem.querySelector('.task-progress-bar');
          const statusElem = taskItem.querySelector('.task-status');
          
          progressBar.style.width = `${percent}%`;
          statusElem.textContent = status;
          
          // Color coding based on progress
          if (percent === 100) {
            progressBar.classList.remove('bg-blue-600');
            progressBar.classList.add('bg-green-600');
          } else if (percent > 0) {
            progressBar.classList.remove('bg-blue-600');
            progressBar.classList.add('bg-blue-500');
          }
        }
      }
      
      displayResults(results, fileName) {
        // Show results dashboard
        document.getElementById('resultsDashboard').classList.remove('hidden');
        document.getElementById('progressContainer').classList.add('hidden');
        document.getElementById('downloadReport').classList.remove('hidden');
        document.getElementById('exportOptionsButton').classList.remove('hidden');
        
        // Set scan timestamp
        const scanDate = new Date(results.fileProperties.scanTimestamp);
        document.getElementById('scanTimestamp').textContent = `Scanned on: ${scanDate.toLocaleString()}`;
        
        // Update threat score indicators
        this.updateThreatScore(results.stats);
        
        // Update metrics
        document.getElementById('totalIssuesMetric').textContent = results.stats.totalIssues;
        document.getElementById('criticalIssuesMetric').textContent = results.stats.criticalIssues;
        document.getElementById('highIssuesMetric').textContent = results.stats.highIssues;
        document.getElementById('mediumIssuesMetric').textContent = results.stats.mediumIssues;
        
        // Update document properties
        document.getElementById('quickStats').innerHTML = this.generateDocumentPropertiesHTML(results, fileName);
        
        // Update threat gauge
        this.createThreatGauge(results.stats.threatScore, results.stats.threatVerdict);
        
        // Update risk chart
        this.updateRiskChart(results);
        
        // Generate risk heatmap
        this.createRiskHeatmap(results);
        
        // Display top threats
        this.displayTopThreats(results);
        
        // Display intelligent insights
        this.displayIntelligentInsights(results.intelligentInsights);
        
        // Update document integrity indicators
        this.updateIntegrityIndicators(results);
        
        // Update security results tab
        this.displaySecurityResults(results.security);
        
        // Update PDF structure tab
        this.displayPDFStructure(results.structure);
        
        // Update object hierarchy visualization
        this.visualizeObjectHierarchy(results.structure.objectHierarchy);
        
        // Update Objects tab
        this.displayObjectsTable(results.deepAnnotations);
        
        // Update Metadata tab
        this.displayMetadata(results.metadata);
        
        // Update JavaScript tab
        this.displayJavaScriptAnalysis(results.javascriptContent);
        
        // Update Content Preview tab
        document.getElementById('pdfText').value = results.textSample || results.text;
        this.createSafePreview(results);
        
        // Update Network tab
        this.displayNetworkAnalysis(results.networkReferences);
        
        // Update Recommendations tab
        this.displayRecommendations(results.recommendations);
        
        // Switch to security tab
        this.switchTab('security');
      }
      
      updateThreatScore(stats) {
        const threatScore = stats.threatScore;
        const summaryThreatScore = document.getElementById('summaryThreatScore');
        
        // Set score text
        summaryThreatScore.textContent = threatScore;
        
        // Set color based on severity
        let bgColor = 'bg-green-500';
        if (threatScore >= 80) bgColor = 'bg-red-500';
        else if (threatScore >= 60) bgColor = 'bg-orange-500';
        else if (threatScore >= 40) bgColor = 'bg-yellow-500';
        else if (threatScore >= 20) bgColor = 'bg-blue-500';
        
        // Remove old classes and add new one
        summaryThreatScore.className = 'rounded-full w-16 h-16 flex items-center justify-center text-white font-bold text-2xl ' + bgColor;
      }
      
      createThreatGauge(score, verdict) {
        const container = document.getElementById('threatGaugeContainer');
        container.innerHTML = '';
        
        // Create SVG for gauge
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 100 100');
        svg.setAttribute('class', 'w-full');
        
        // Background circle
        const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        bgCircle.setAttribute('cx', '50');
        bgCircle.setAttribute('cy', '50');
        bgCircle.setAttribute('r', '40');
        bgCircle.setAttribute('class', 'gauge-bg');
        svg.appendChild(bgCircle);
        
        // Value arc
        const arc = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        arc.setAttribute('cx', '50');
        arc.setAttribute('cy', '50');
        arc.setAttribute('r', '40');
        arc.setAttribute('class', 'gauge-fill');
        
        // Calculate arc color and length
        let strokeColor = 'green';
        if (score >= 80) strokeColor = 'red';
        else if (score >= 60) strokeColor = 'orange';
        else if (score >= 40) strokeColor = 'gold';
        else if (score >= 20) strokeColor = 'blue';
        
        arc.setAttribute('stroke', strokeColor);
        
        // Calculate the dash array for the circle
        const circumference = 2 * Math.PI * 40;
        const fillPercent = score / 100;
        const dashArray = `${fillPercent * circumference} ${circumference}`;
        
        arc.setAttribute('stroke-dasharray', dashArray);
        arc.setAttribute('transform', 'rotate(-90 50 50)');
        svg.appendChild(arc);
        
        // Center circle
        const centerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        centerCircle.setAttribute('cx', '50');
        centerCircle.setAttribute('cy', '50');
        centerCircle.setAttribute('r', '30');
        centerCircle.setAttribute('class', 'gauge-center');
        svg.appendChild(centerCircle);
        
        // Score text
        const scoreText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        scoreText.setAttribute('x', '50');
        scoreText.setAttribute('y', '45');
        scoreText.setAttribute('text-anchor', 'middle');
        scoreText.setAttribute('class', 'gauge-value');
        scoreText.textContent = score;
        svg.appendChild(scoreText);
        
        // "of 100" text
        const ofText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        ofText.setAttribute('x', '50');
        ofText.setAttribute('y', '60');
        ofText.setAttribute('text-anchor', 'middle');
        ofText.setAttribute('class', 'gauge-label');
        ofText.textContent = 'of 100';
        svg.appendChild(ofText);
        
        container.appendChild(svg);
        
        // Add verdict text
        document.getElementById('threatVerdictText').innerHTML = `
          <strong class="font-medium" style="color:${strokeColor}">${verdict}</strong>
          <p class="mt-1">This document has been assessed with a ${score}/100 threat score.</p>
        `;
      }
      
      updateRiskChart(results) {
        // Prepare data for chart
        const labels = [];
        const data = [];
        const colors = [];
        
        for (const [category, findings] of Object.entries(results.security)) {
          if (findings.length > 0) {
            let critical = 0, high = 0, medium = 0, low = 0;
            findings.forEach(f => {
              const count = f.matches || 1;
              if (f.severity === 'critical') critical += count;
              else if (f.severity === 'high') high += count;
              else if (f.severity === 'medium') medium += count;
              else low += count;
            });
            
            // Only include categories with actual findings
            if (critical + high + medium + low > 0) {
              // Format category name
              const formattedCategory = this.formatCategoryName(category);
              labels.push(formattedCategory);
              data.push(critical + high + medium + low);
              
              // Set color based on highest severity in this category
              if (critical > 0) colors.push('rgba(239, 68, 68, 0.7)'); // red
              else if (high > 0) colors.push('rgba(249, 115, 22, 0.7)'); // orange
              else if (medium > 0) colors.push('rgba(234, 179, 8, 0.7)'); // yellow
              else colors.push('rgba(59, 130, 246, 0.7)'); // blue
            }
          }
        }
        
        // Create risk chart
        const ctx = document.getElementById("riskChart").getContext("2d");
        if (window.riskChartInstance) window.riskChartInstance.destroy();
        
        window.riskChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "Issues Found",
              data: data,
              backgroundColor: colors,
              borderColor: colors.map(c => c.replace('0.7', '1')),
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            scales: {
              x: { 
                beginAtZero: true, 
                title: {
                  display: true,
                  text: 'Issues Found'
                }
              }
            },
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.parsed.x} issue(s) found`;
                  }
                }
              }
            }
          }
        });
      }
      
      createRiskHeatmap(results) {
        const container = document.getElementById('riskHeatmapContainer');
        container.innerHTML = '';
        
        // Create heat map cells based on security findings
        const cells = [];
        let maxValue = 0;
        
        // Process security findings to generate heatmap data
        for (const [category, findings] of Object.entries(results.security)) {
          findings.forEach(finding => {
            const weight = this.getSeverityWeight(finding.severity);
            const value = (finding.matches || 1) * weight;
            maxValue = Math.max(maxValue, value);
            
            cells.push({
              category,
              severity: finding.severity,
              value,
              description: finding.description || 'Pattern match',
              matches: finding.matches || 1
            });
          });
        }
        
        // Sort cells by value
        cells.sort((a, b) => b.value - a.value);
        
        // Limit to top 20 cells for visibility
        const displayCells = cells.slice(0, 20);
        
        // Create tooltip element
        const tooltip = document.createElement('div');
        tooltip.className = 'heat-map-tooltip hidden';
        container.appendChild(tooltip);
        
        // Create heat map
        const width = container.offsetWidth;
        const height = 160;
        const cellWidth = 25;
        const cellHeight = 25;
        const numRows = 4;
        const numCols = Math.floor(width / cellWidth);
        
        // Create cells
        displayCells.forEach((cell, index) => {
          if (index >= numRows * numCols) return;
          
          const row = Math.floor(index / numCols);
          const col = index % numCols;
          
          const heatCell = document.createElement('div');
          heatCell.className = 'heat-map-cell';
          heatCell.style.width = `${cellWidth}px`;
          heatCell.style.height = `${cellHeight}px`;
          heatCell.style.left = `${col * cellWidth}px`;
          heatCell.style.top = `${row * cellHeight}px`;
          
          // Color by severity
          let bgColor;
          if (cell.severity === 'critical') bgColor = 'rgba(239, 68, 68, ';
          else if (cell.severity === 'high') bgColor = 'rgba(249, 115, 22, ';
          else if (cell.severity === 'medium') bgColor = 'rgba(234, 179, 8, ';
          else bgColor = 'rgba(59, 130, 246, ';
          
          // Intensity by value
          const intensity = Math.max(0.3, Math.min(0.9, cell.value / maxValue));
          heatCell.style.backgroundColor = `${bgColor}${intensity})`;
          
          // Tooltip events
          heatCell.addEventListener('mouseover', (e) => {
            tooltip.innerHTML = `
              <strong>${this.formatCategoryName(cell.category)}</strong><br>
              ${cell.description}<br>
              <span class="font-semibold">${cell.severity.toUpperCase()}</span> severity, 
              ${cell.matches} match(es)
            `;
            tooltip.style.left = `${e.pageX - container.getBoundingClientRect().left + 10}px`;
            tooltip.style.top = `${e.pageY - container.getBoundingClientRect().top + 10}px`;
            tooltip.classList.remove('hidden');
          });
          
          heatCell.addEventListener('mouseout', () => {
            tooltip.classList.add('hidden');
          });
          
          container.appendChild(heatCell);
        });
        
        // Add legend
        const legend = document.createElement('div');
        legend.className = 'mt-4 flex justify-between text-xs text-gray-600';
        legend.innerHTML = `
          <div class="flex items-center">
            <span class="inline-block w-3 h-3 rounded-sm mr-1" style="background-color: rgba(59, 130, 246, 0.7)"></span>
            <span>Low</span>
          </div>
          <div class="flex items-center">
            <span class="inline-block w-3 h-3 rounded-sm mr-1" style="background-color: rgba(234, 179, 8, 0.7)"></span>
            <span>Medium</span>
          </div>
          <div class="flex items-center">
            <span class="inline-block w-3 h-3 rounded-sm mr-1" style="background-color: rgba(249, 115, 22, 0.7)"></span>
            <span>High</span>
          </div>
          <div class="flex items-center">
            <span class="inline-block w-3 h-3 rounded-sm mr-1" style="background-color: rgba(239, 68, 68, 0.7)"></span>
            <span>Critical</span>
          </div>
        `;
        container.appendChild(legend);
      }
      
      displayTopThreats(results) {
        const container = document.getElementById('topThreatsContainer');
        container.innerHTML = '';
        
        // Collect all findings
        const allFindings = [];
        for (const [category, findings] of Object.entries(results.security)) {
          findings.forEach(finding => {
            allFindings.push({
              category,
              severity: finding.severity,
              description: finding.description || 'Pattern match',
              matches: finding.matches || 1,
              examples: finding.examples || [],
              context: finding.context || []
            });
          });
        }
        
        // Add raw findings
        results.rawScanFindings.forEach(finding => {
          allFindings.push({
            category: 'Raw Analysis',
            severity: finding.severity,
            description: finding.message || finding.type,
            matches: 1,
            examples: [],
            context: []
          });
        });
        
        // Sort by severity
        allFindings.sort((a, b) => {
          const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
          return severityOrder[a.severity] - severityOrder[b.severity];
        });
        
        // Display top threats
        if (allFindings.length === 0) {
          container.innerHTML = `<div class="text-center py-4 text-gray-500">No security issues detected</div>`;
          return;
        }
        
        // Display top 3 threats
        allFindings.slice(0, 3).forEach(finding => {
          const severityColor = this.getSeverityColor(finding.severity);
          
          const threatItem = document.createElement('div');
          threatItem.className = `p-4 rounded-lg border-l-4 ${severityColor}`;
          
          // Format the content
          let threatHTML = `
            <div class="flex justify-between items-start">
              <div>
                <span class="inline-block px-2 py-1 text-xs rounded bg-opacity-20 ${severityColor} mb-2">
                  ${finding.severity.toUpperCase()}
                </span>
                <h4 class="font-semibold">${this.formatCategoryName(finding.category)}</h4>
              </div>
              <div class="text-sm text-gray-500">${finding.matches} match(es)</div>
            </div>
            <p class="text-sm mt-1">${finding.description}</p>
          `;
          
          // Add example if available
          if (finding.examples && finding.examples.length > 0) {
            threatHTML += `
              <div class="mt-2 text-xs bg-gray-50 p-2 rounded font-mono overflow-x-auto">
                ${this.escapeHtml(finding.examples[0]).substring(0, 100)}${finding.examples[0].length > 100 ? '...' : ''}
              </div>
            `;
          }
          
          threatItem.innerHTML = threatHTML;
          container.appendChild(threatItem);
        });
      }
      
      displayIntelligentInsights(insights) {
        const container = document.getElementById('intelligentInsights');
        container.innerHTML = '';
        
        if (!insights || insights.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-gray-500">No insights available</div>';
          return;
        }
        
        insights.forEach(insight => {
          let insightClass = 'bg-blue-50 border-blue-300';
          if (insight.severity === 'critical') insightClass = 'bg-red-50 border-red-300';
          else if (insight.severity === 'high') insightClass = 'bg-orange-50 border-orange-300';
          else if (insight.severity === 'medium') insightClass = 'bg-yellow-50 border-yellow-300';
          
          const insightElem = document.createElement('div');
          insightElem.className = `p-3 rounded-lg border-l-4 ${insightClass}`;
          
          let insightHTML = `
            <h4 class="font-semibold text-sm">${insight.title}</h4>
            <p class="text-sm mt-1">${insight.description}</p>
          `;
          
          // Add URLs if available
          if (insight.urls && insight.urls.length > 0) {
            insightHTML += `
              <div class="mt-2 text-xs font-mono">
                ${insight.urls.map(url => `<div class="truncate">${this.escapeHtml(url)}</div>`).join('')}
              </div>
            `;
          }
          
          insightElem.innerHTML = insightHTML;
          container.appendChild(insightElem);
        });
      }
      
      updateIntegrityIndicators(results) {
        // Initialize indicators
        const indicators = {
          signature: { elem: document.getElementById('signatureStatus'), textElem: document.getElementById('signatureStatusText') },
          encryption: { elem: document.getElementById('encryptionStatus'), textElem: document.getElementById('encryptionStatusText') },
          modification: { elem: document.getElementById('modificationStatus'), textElem: document.getElementById('modificationStatusText') },
          consistency: { elem: document.getElementById('consistencyStatus'), textElem: document.getElementById('consistencyStatusText') }
        };
        
        // Digital signature
        let hasSig = results.metadata && results.metadata.signatureInfo;
        indicators.signature.elem.className = `status-indicator ${hasSig ? 'status-safe' : 'status-unknown'}`;
        indicators.signature.textElem.textContent = `Digital Signature: ${hasSig ? 'Valid' : 'Not signed'}`;
        
        // Encryption
        let isEncrypted = results.metadata && results.metadata.encrypted;
        indicators.encryption.elem.className = `status-indicator ${isEncrypted ? 'status-safe' : 'status-unknown'}`;
        indicators.encryption.textElem.textContent = `Encryption: ${isEncrypted ? 'Encrypted' : 'Not encrypted'}`;
        
        // Modifications
        let hasModifications = false;
        // Check for incremental updates in raw findings
        results.rawScanFindings.forEach(finding => {
          if (finding.type === 'Incremental Updates') {
            hasModifications = true;
          }
        });
        
        indicators.modification.elem.className = `status-indicator ${hasModifications ? 'status-warning' : 'status-safe'}`;
        indicators.modification.textElem.textContent = `Modifications: ${hasModifications ? 'Modified' : 'Original'}`;
        
        // Structure consistency
        let hasConsistency = true;
        // Check for structure errors
        if (results.error || (results.structure && results.structure.error)) {
          hasConsistency = false;
        }
        
        indicators.consistency.elem.className = `status-indicator ${hasConsistency ? 'status-safe' : 'status-critical'}`;
        indicators.consistency.textElem.textContent = `Structure Consistency: ${hasConsistency ? 'Valid' : 'Invalid'}`;
      }
      
      displaySecurityResults(securityResults) {
        const container = document.getElementById('securityResults');
        
        if (!securityResults) {
          container.innerHTML = '<div class="text-center py-4 text-gray-500">No security results available</div>';
          return;
        }
        
        let securityHTML = '';
        let hasIssues = false;
        
        // Process each security category
        for (const [category, findings] of Object.entries(securityResults)) {
          if (findings.length > 0) {
            hasIssues = true;
            
            securityHTML += `
              <div class="mb-8 security-category" data-category="${category}">
                <h3 class="text-lg font-semibold mb-3">${this.formatCategoryName(category)}</h3>
                <div class="space-y-4">
            `;
            
            // Process findings within this category
            findings.forEach(finding => {
              const severityClass = this.getSeverityColorClass(finding.severity);
              
              securityHTML += `
                <div class="mb-4 p-4 rounded-lg ${severityClass} security-finding" data-severity="${finding.severity}">
                  <div class="flex justify-between items-center">
                    <span class="font-semibold">${finding.severity.toUpperCase()}</span>
                    <span class="text-sm px-2 py-1 rounded">${finding.matches} match(es)</span>
                  </div>
                  <div class="mt-2 text-sm">
                    <div class="mb-2">${finding.description || 'Pattern match'}</div>
                    <div class="font-mono bg-white bg-opacity-50 p-2 rounded text-xs">
                      Pattern: ${this.escapeHtml(finding.pattern)}
                    </div>
                    <div class="text-xs text-gray-600 mt-1">Found in: ${this.escapeHtml(finding.source)}</div>
                    ${finding.examples && finding.examples.length > 0 ? `
                      <div class="mt-2">
                        <button class="text-xs text-blue-600 hover:text-blue-800 toggle-examples">
                          Show examples â–¼
                        </button>
                        <div class="hidden mt-2 examples-content">
                          <div class="font-semibold text-xs">Examples:</div>
                          <div class="space-y-2">
                            ${finding.examples.map((ex, i) => `
                              <div class="text-xs bg-gray-50 p-2 rounded font-mono overflow-x-auto">
                                ${this.escapeHtml(ex)}
                                ${finding.context && finding.context[i] ? `
                                  <div class="mt-1 text-xs text-gray-500">Context: ${this.escapeHtml(finding.context[i])}</div>
                                ` : ''}
                              </div>
                            `).join('')}
                          </div>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              `;
            });
            
            securityHTML += `
                </div>
              </div>
            `;
          }
        }
        
        if (!hasIssues) {
          securityHTML = `
            <div class="text-center py-10">
              <div class="inline-block p-3 rounded-full bg-green-50 mb-4">
                <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <p class="text-gray-500">No security issues detected in this document</p>
            </div>
          `;
        }
        
        container.innerHTML = securityHTML;
        
        // Add toggle event listeners
        document.querySelectorAll('.toggle-examples').forEach(button => {
          button.addEventListener('click', () => {
            const content = button.nextElementSibling;
            content.classList.toggle('hidden');
            button.textContent = content.classList.contains('hidden') ? 
              'Show examples â–¼' : 'Hide examples â–²';
          });
        });
      }
      
      filterSecurityResults(severity) {
        const findings = document.querySelectorAll('.security-finding');
        const categories = document.querySelectorAll('.security-category');
        
        findings.forEach(finding => {
          const findingSeverity = finding.dataset.severity;
          
          if (severity === 'all') {
            finding.classList.remove('hidden');
          } else if (severity === 'critical') {
            finding.classList.toggle('hidden', findingSeverity !== 'critical');
          } else if (severity === 'high') {
            finding.classList.toggle('hidden', 
              findingSeverity !== 'critical' && findingSeverity !== 'high');
          } else if (severity === 'medium') {
            finding.classList.toggle('hidden', 
              findingSeverity !== 'critical' && findingSeverity !== 'high' && findingSeverity !== 'medium');
          }
        });
        
        // Hide empty categories
        categories.forEach(category => {
          const visibleFindings = category.querySelectorAll('.security-finding:not(.hidden)');
          category.classList.toggle('hidden', visibleFindings.length === 0);
        });
      }
      
      displayPDFStructure(structure) {
        const container = document.getElementById('pdfStructure');
        if (!structure || !structure.pages) {
          container.innerHTML = '<div class="text-center py-4 text-gray-500">No structure information available</div>';
          return;
        }
        
        // Generate pages table
        let structureHTML = `
          <div class="mb-6">
            <h4 class="text-md font-semibold mb-2">Pages Overview</h4>
            <table class="min-w-full">
              <thead>
                <tr>
                  <th class="border px-2 py-1">Page</th>
                  <th class="border px-2 py-1">Size</th>
                  <th class="border px-2 py-1">Annotations</th>
                  <th class="border px-2 py-1">JavaScript</th>
                  <th class="border px-2 py-1">Links</th>
                  <th class="border px-2 py-1">Actions</th>
                  <th class="border px-2 py-1">Forms</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        structure.pages.forEach(page => {
          const hasError = page.error;
          
          structureHTML += `
            <tr class="hover:bg-blue-50 transition-colors duration-150">
              <td class="border px-2 py-1">${page.pageNumber}</td>
              <td class="border px-2 py-1">${hasError ? 'N/A' : `${page.width}Ã—${page.height}`}</td>
              <td class="border px-2 py-1">${hasError ? 'N/A' : page.annotations}</td>
              <td class="border px-2 py-1 ${page.hasJavaScript ? 'bg-red-50' : ''}">${hasError ? 'N/A' : (page.hasJavaScript ? 'Yes' : 'No')}</td>
              <td class="border px-2 py-1">${hasError ? 'N/A' : (page.hasLinks ? 'Yes' : 'No')}</td>
              <td class="border px-2 py-1 ${page.hasActions ? 'bg-yellow-50' : ''}">${hasError ? 'N/A' : (page.hasActions ? 'Yes' : 'No')}</td>
              <td class="border px-2 py-1">${hasError ? 'N/A' : (page.hasFormFields ? 'Yes' : 'No')}</td>
            </tr>
          `;
        });
        
        structureHTML += `
              </tbody>
            </table>
          </div>
        `;
        
        // Generate document information
        if (structure.documentInfo) {
          structureHTML += `
            <div class="mb-6">
              <h4 class="text-md font-semibold mb-2">Document Information</h4>
              <div class="bg-gray-50 p-4 rounded">
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div class="font-semibold">Page Count:</div>
                  <div>${structure.documentInfo.pageCount}</div>
                  <div class="font-semibold">XFA Forms:</div>
                  <div>${structure.documentInfo.hasXfa ? 'Yes' : 'No'}</div>
                  <div class="font-semibold">AcroForm:</div>
                  <div>${structure.documentInfo.hasAcroform ? 'Yes' : 'No'}</div>
                  <div class="font-semibold">Structure Tree:</div>
                  <div>${structure.documentInfo.hasStructTreeRoot ? 'Yes' : 'No'}</div>
                </div>
              </div>
            </div>
          `;
        }
        
        // Display annotation types if available
        if (structure.pages && structure.pages.some(p => p.annotationTypes)) {
          // Collect all annotation types across pages
          const annotationTypes = {};
          structure.pages.forEach(page => {
            if (page.annotationTypes) {
              Object.entries(page.annotationTypes).forEach(([type, count]) => {
                annotationTypes[type] = (annotationTypes[type] || 0) + count;
              });
            }
          });
          
          if (Object.keys(annotationTypes).length > 0) {
            structureHTML += `
              <div class="mb-6">
                <h4 class="text-md font-semibold mb-2">Annotation Types</h4>
                <div class="bg-gray-50 p-4 rounded">
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    ${Object.entries(annotationTypes).map(([type, count]) => `
                      <div class="font-semibold">${type}:</div>
                      <div>${count}</div>
                    `).join('')}
                  </div>
                </div>
              </div>
            `;
          }
        }
        
        container.innerHTML = structureHTML;
      }
      
      visualizeObjectHierarchy(hierarchy) {
        const container = document.getElementById('objectHierarchy');
        if (!hierarchy) {
          container.innerHTML = '<div class="text-center py-4 text-gray-500">No object hierarchy information available</div>';
          return;
        }
        
        // Create a D3.js tree visualization
        container.innerHTML = '';
        
        const width = container.clientWidth;
        const height = 550;
        
        const svg = d3.select(container)
          .append("svg")
          .attr("width", width)
          .attr("height", height);
        
        const g = svg.append("g")
          .attr("transform", `translate(${width / 2}, 20)`);
        
        // Create hierarchy
        const root = d3.hierarchy(hierarchy);
        
        // Set fixed depth for tree layout
        const treeLayout = d3.tree().size([width - 100, height - 50]);
        treeLayout(root);
        
        // Create links
        g.selectAll(".link")
          .data(root.links())
          .enter()
          .append("path")
          .attr("class", "link")
          .attr("d", d3.linkVertical()
            .x(d => d.x - width / 2)
            .y(d => d.y));
        
        // Create nodes
        const nodes = g.selectAll(".node")
          .data(root.descendants())
          .enter()
          .append("g")
          .attr("class", "node")
          .attr("transform", d => `translate(${d.x - width / 2}, ${d.y})`);
        
        // Add circles to nodes
        nodes.append("circle")
          .attr("r", 5)
          .style("fill", d => {
            if (d.data.type === "Document") return "#3b82f6";
            if (d.data.type === "Catalog") return "#10b981";
            if (d.data.type === "Pages") return "#8b5cf6";
            if (d.data.type === "Page") return "#f59e0b";
            if (d.data.type === "Annotations") return "#ef4444";
            return "#6b7280";
          });
        
        // Add text labels
        nodes.append("text")
          .attr("dy", ".35em")
          .attr("y", d => d.children ? -10 : 10)
          .style("text-anchor", "middle")
          .text(d => {
            if (d.data.type === "Page") return `Page ${d.data.id}`;
            return d.data.type;
          });
        
        // Add zoom capability
        const zoom = d3.zoom()
          .scaleExtent([0.5, 3])
          .on("zoom", (event) => {
            g.attr("transform", event.transform);
          });
        
        svg.call(zoom);
      }
      
      displayObjectsTable(objects) {
        const container = document.getElementById('objectTable');
        if (!objects || objects.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-gray-500">No objects found</div>';
          return;
        }
        
        // Build the table with enhanced information
        let html = `
          <table class="min-w-full object-table">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="border px-2 py-1 text-left">Page</th>
                <th class="border px-2 py-1 text-left">Type</th>
                <th class="border px-2 py-1 text-left">Field Name</th>
                <th class="border px-2 py-1 text-left">Content</th>
                <th class="border px-2 py-1 text-left">URL</th>
                <th class="border px-2 py-1 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        objects.forEach(obj => {
          // Skip objects with errors
          if (obj.error) return;
          
          // Get action count
          const actionCount = obj.actions ? Object.keys(obj.actions).length : 0;
          
          // Determine if this object has JavaScript
          const hasJavaScript = obj.actions && 
            (obj.actions.JS || obj.actions.JavaScript || 
             Object.values(obj.actions).some(a => 
               a.value && typeof a.value === 'string' && 
               a.value.includes('JavaScript')
             ));
          
          html += `
            <tr class="pdf-object hover:bg-blue-50" data-type="${obj.subtype?.toLowerCase() || ''}" data-field="${obj.fieldName || ''}">
              <td class="border px-2 py-1">${obj.page}</td>
              <td class="border px-2 py-1 ${hasJavaScript ? 'bg-red-50' : ''}">${obj.subtype || 'Unknown'} ${obj.fieldType ? `(${obj.fieldType})` : ''}</td>
              <td class="border px-2 py-1">${obj.fieldName || ''}</td>
              <td class="border px-2 py-1">
                <div class="max-h-24 overflow-y-auto text-xs">
                  ${obj.contents ? this.escapeHtml(obj.contents).substring(0, 200) + (obj.contents.length > 200 ? '...' : '') : ''}
                </div>
              </td>
              <td class="border px-2 py-1">
                <div class="max-w-xs truncate text-xs ${obj.url ? 'text-blue-600' : ''}">
                  ${obj.url || ''}
                </div>
              </td>
              <td class="border px-2 py-1 ${actionCount > 0 ? 'bg-yellow-50' : ''}">
                ${actionCount > 0 ? `
                  <button class="text-xs text-blue-600 hover:text-blue-800 view-actions">
                    View ${actionCount} action(s)
                  </button>
                  <div class="hidden actions-detail bg-gray-50 p-2 mt-2 rounded text-xs">
                    ${Object.entries(obj.actions).map(([key, action]) => `
                      <div class="mb-2">
                        <strong>${key}:</strong>
                        <pre class="mt-1 text-xs overflow-x-auto whitespace-pre-wrap">${this.escapeHtml(action.value || 'N/A')}</pre>
                      </div>
                    `).join('')}
                  </div>
                ` : 'None'}
              </td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>
        `;
        
        container.innerHTML = html;
        
        // Add event listeners for action toggles
        document.querySelectorAll('.view-actions').forEach(button => {
          button.addEventListener('click', (e) => {
            e.stopPropagation();
            const detail = button.nextElementSibling;
            detail.classList.toggle('hidden');
            button.textContent = detail.classList.contains('hidden') ? 
              `View ${button.textContent.split(' ')[1]} action(s)` : 
              `Hide ${button.textContent.split(' ')[1]} action(s)`;
          });
        });
      }
      
      filterObjects(type) {
        const rows = document.querySelectorAll('.object-table tbody tr');
        
        rows.forEach(row => {
          if (type === 'all') {
            row.classList.remove('hidden');
          } else if (type === 'annotation') {
            row.classList.toggle('hidden', !row.dataset.type || row.dataset.type === 'unknown');
          } else if (type === 'action') {
            const hasActions = row.querySelector('.view-actions');
            row.classList.toggle('hidden', !hasActions);
          } else if (type === 'form') {
            row.classList.toggle('hidden', !row.dataset.field);
          } else if (type === 'javascript') {
            const hasJS = row.querySelector('td:nth-child(2).bg-red-50') || 
                         row.querySelector('.actions-detail')?.textContent.includes('JavaScript');
            row.classList.toggle('hidden', !hasJS);
          } else if (type === 'embedded') {
            row.classList.toggle('hidden', row.dataset.type !== 'fileattachment');
          }
        });
      }
      
      searchObjects(query) {
        if (!query || query.trim() === '') {
          document.querySelectorAll('.object-table tbody tr').forEach(row => {
            row.classList.remove('hidden');
          });
          return;
        }
        
        const rows = document.querySelectorAll('.object-table tbody tr');
        const lowerQuery = query.toLowerCase();
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.classList.toggle('hidden', !text.includes(lowerQuery));
        });
      }
      
      displayMetadata(metadata) {
        const metadataContainer = document.getElementById('metadata');
        const extendedContainer = document.getElementById('extendedMetadata');
        const authorContainer = document.getElementById('authorMetadata');
        
        if (!metadata) {
          metadataContainer.innerHTML = '<div class="text-center py-4 text-gray-500">No metadata available</div>';
          extendedContainer.innerHTML = '<div class="text-center py-4 text-gray-500">No extended properties available</div>';
          authorContainer.innerHTML = '<div class="text-center py-4 text-gray-500">No author information available</div>';
          return;
        }
        
        // Raw metadata display
        metadataContainer.innerHTML = `<pre class="whitespace-pre-wrap">${JSON.stringify(metadata, null, 2)}</pre>`;
        
        // Extended metadata display
        let extendedHTML = '';
        
        // Version
        extendedHTML += `
          <div class="p-4 bg-gray-50 rounded">
            <h4 class="font-semibold mb-2">Document Version</h4>
            <div class="text-3xl font-bold text-blue-600">PDF ${metadata.version || 'Unknown'}</div>
            ${metadata.encrypted ? '<p class="mt-2 text-sm text-gray-600">This document is encrypted</p>' : ''}
          </div>
        `;
        
        // Dates
        if (metadata.creationDateFormatted || metadata.modDateFormatted || metadata.CreationDate || metadata.ModDate) {
          extendedHTML += `
            <div class="p-4 bg-gray-50 rounded">
              <h4 class="font-semibold mb-2">Document Dates</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                <div class="font-semibold">Created:</div>
                <div>${metadata.creationDateFormatted || metadata.CreationDate || 'Unknown'}</div>
                <div class="font-semibold">Last Modified:</div>
                <div>${metadata.modDateFormatted || metadata.ModDate || 'Unknown'}</div>
              </div>
            </div>
          `;
        }
        
        // Software analysis
        if (metadata.producerAnalysis || metadata.creatorAnalysis) {
          extendedHTML += `
            <div class="p-4 bg-gray-50 rounded">
              <h4 class="font-semibold mb-2">Software Analysis</h4>
              <div class="space-y-3">
          `;
          
          if (metadata.producerAnalysis) {
            const trustClass = metadata.producerAnalysis.trust === 'high' ? 'text-green-600' :
                            metadata.producerAnalysis.trust === 'medium' ? 'text-yellow-600' :
                            metadata.producerAnalysis.trust === 'low' ? 'text-orange-600' : 'text-red-600';
            
            extendedHTML += `
              <div>
                <div class="font-semibold">Producer Software:</div>
                <div class="flex items-center">
                  <span class="mr-2">${metadata.producerAnalysis.name} ${metadata.producerAnalysis.version}</span>
                  <span class="text-xs ${trustClass}">(${metadata.producerAnalysis.trust} trust)</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">${metadata.Producer || ''}</div>
              </div>
            `;
          }
          
          if (metadata.creatorAnalysis) {
            const trustClass = metadata.creatorAnalysis.trust === 'high' ? 'text-green-600' :
                            metadata.creatorAnalysis.trust === 'medium' ? 'text-yellow-600' :
                            metadata.creatorAnalysis.trust === 'low' ? 'text-orange-600' : 'text-red-600';
            
            extendedHTML += `
              <div>
                <div class="font-semibold">Creator Software:</div>
                <div class="flex items-center">
                  <span class="mr-2">${metadata.creatorAnalysis.name} ${metadata.creatorAnalysis.version}</span>
                  <span class="text-xs ${trustClass}">(${metadata.creatorAnalysis.trust} trust)</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">${metadata.Creator || ''}</div>
              </div>
            `;
          }
          
          extendedHTML += `
              </div>
            </div>
          `;
        }
        
        extendedContainer.innerHTML = extendedHTML;
        
        // Author information
        let authorHTML = '';
        const authorFields = ['Author', 'Subject', 'Keywords', 'Title'];
        const hasAuthorInfo = authorFields.some(field => metadata[field]);
        
        if (hasAuthorInfo) {
          authorHTML += `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-gray-50 rounded">
                <h4 class="font-semibold mb-3">Document Information</h4>
                <div class="space-y-3">
                  <div>
                    <div class="font-semibold">Title:</div>
                    <div>${metadata.Title || 'Not specified'}</div>
                  </div>
                  <div>
                    <div class="font-semibold">Subject:</div>
                    <div>${metadata.Subject || 'Not specified'}</div>
                  </div>
                  <div>
                    <div class="font-semibold">Keywords:</div>
                    <div>${metadata.Keywords || 'Not specified'}</div>
                  </div>
                </div>
              </div>
              
              <div class="p-4 bg-gray-50 rounded">
                <h4 class="font-semibold mb-3">Author Information</h4>
                <div class="space-y-3">
                  <div>
                    <div class="font-semibold">Author:</div>
                    <div>${metadata.Author || 'Not specified'}</div>
                  </div>
                  <div>
                    <div class="font-semibold">Creator:</div>
                    <div>${metadata.Creator || 'Not specified'}</div>
                  </div>
                  <div>
                    <div class="font-semibold">Producer:</div>
                    <div>${metadata.Producer || 'Not specified'}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else {
          authorHTML = '<div class="text-center py-4 text-gray-500">No author information available</div>';
        }
        
        authorContainer.innerHTML = authorHTML;
      }
      
      displayJavaScriptAnalysis(jsContent) {
        const jsContainer = document.getElementById('javascriptContent');
        const jsStatsContainer = document.getElementById('jsStats');
        const jsCodeBlocksContainer = document.getElementById('jsCodeBlocks');
        
        if (!jsContent || jsContent.length === 0) {
          jsContainer.innerHTML = `
            <div class="text-center py-10">
              <div class="inline-block p-3 rounded-full bg-green-50 mb-4">
                <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <p class="text-gray-700 font-medium">No JavaScript detected</p>
              <p class="text-gray-500 mt-2">This document does not contain any JavaScript code.</p>
            </div>
          `;
          return;
        }
        
        // Statistics
        const totalJs = jsContent.length;
        const highRiskJs = jsContent.filter(js => js.analysis && js.analysis.risk === 'high' || js.analysis.risk === 'critical').length;
        const obfuscatedJs = jsContent.filter(js => js.analysis && js.analysis.obfuscated).length;
        const hasNetworkAccess = jsContent.some(js => 
          js.analysis && js.analysis.suspiciousAPIs && 
          js.analysis.suspiciousAPIs.some(api => 
            api.includes('URL') || api.includes('XHR') || api.includes('fetch')
          )
        );
        
        // Display statistics
        jsStatsContainer.innerHTML = `
          <div class="bg-blue-50 p-4 rounded-lg">
            <div class="text-xl font-bold text-blue-800">${totalJs}</div>
            <div class="text-sm text-blue-600">JavaScript Blocks</div>
          </div>
          <div class="bg-red-50 p-4 rounded-lg">
            <div class="text-xl font-bold text-red-800">${highRiskJs}</div>
            <div class="text-sm text-red-600">High Risk Scripts</div>
          </div>
          <div class="bg-orange-50 p-4 rounded-lg">
            <div class="text-xl font-bold text-orange-800">${obfuscatedJs}</div>
            <div class="text-sm text-orange-600">Obfuscated Scripts</div>
          </div>
          <div class="bg-yellow-50 p-4 rounded-lg">
            <div class="text-xl font-bold text-yellow-800">${hasNetworkAccess ? 'Yes' : 'No'}</div>
            <div class="text-sm text-yellow-600">Network Access</div>
          </div>
        `;
        
        // Display code blocks
        let codeBlocksHTML = '';
        
        jsContent.forEach((js, index) => {
          const riskClass = js.analysis?.risk === 'critical' ? 'bg-red-50 border-red-300' :
                          js.analysis?.risk === 'high' ? 'bg-orange-50 border-orange-300' :
                          js.analysis?.risk === 'medium' ? 'bg-yellow-50 border-yellow-300' :
                          'bg-blue-50 border-blue-300';
          
          const highlightedCode = this.highlightJsCode(js.code, js.analysis?.highlights);
          
          codeBlocksHTML += `
            <div class="border rounded-lg ${riskClass} overflow-hidden">
              <div class="flex justify-between items-center p-3 border-b">
                <div>
                  <span class="font-semibold">JavaScript Block #${index + 1}</span>
                  <span class="ml-2 text-sm">(${js.source})</span>
                </div>
                <div class="flex items-center">
                  <span class="text-xs px-2 py-1 rounded bg-white bg-opacity-50">
                    Risk: <strong>${js.analysis?.risk.toUpperCase() || 'Unknown'}</strong>
                  </span>
                  <button class="ml-2 text-sm text-blue-600 hover:text-blue-800 js-toggle-details">
                    Details â–¼
                  </button>
                </div>
              </div>
              
              <div class="js-details hidden">
                <div class="p-3 border-b bg-white bg-opacity-50">
                  <h5 class="font-semibold text-sm mb-2">Analysis</h5>
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="font-medium">Length:</div>
                    <div>${js.analysis?.length || 0} characters</div>
                    <div class="font-medium">Obfuscated:</div>
                    <div>${js.analysis?.obfuscated ? 'Yes' : 'No'}</div>
                  </div>
                  
                  ${js.analysis?.suspiciousAPIs && js.analysis.suspiciousAPIs.length > 0 ? `
                    <div class="mt-2">
                      <div class="font-medium text-sm">Suspicious APIs:</div>
                      <div class="flex flex-wrap gap-1 mt-1">
                        ${js.analysis.suspiciousAPIs.map(api => 
                          `<span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded">${api}</span>`
                        ).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
                
                <div class="code-preview p-4 text-sm font-mono overflow-x-auto">
                  ${highlightedCode}
                </div>
              </div>
            </div>
          `;
        });
        
        jsCodeBlocksContainer.innerHTML = codeBlocksHTML;
        
        // Add event listeners for toggles
        document.querySelectorAll('.js-toggle-details').forEach(button => {
          button.addEventListener('click', () => {
            const details = button.closest('.border').querySelector('.js-details');
            details.classList.toggle('hidden');
            button.textContent = details.classList.contains('hidden') ? 
              'Details â–¼' : 'Hide â–²';
          });
        });
      }
      
      highlightJsCode(code, highlights) {
        if (!code) return '';
        
        let highlightedCode = this.escapeHtml(code);
        
        // Apply syntax highlighting for JavaScript (simplified)
        highlightedCode = highlightedCode
          // Keywords
          .replace(/\b(var|let|const|function|return|if|else|for|while|do|switch|case|break|continue|new|this|typeof|instanceof)\b/g, 
            '<span style="color: #07a;">$1</span>')
          // Strings
          .replace(/(['"])(.*?)\1/g, '<span style="color: #690;">$1$2$1</span>')
          // Numbers
          .replace(/\b(\d+)\b/g, '<span style="color: #905;">$1</span>')
          // Comments (simplified)
          .replace(/\/\/(.*)$/gm, '<span style="color: #999;">//$1</span>')
          .replace(/\/\*([\s\S]*?)\*\//g, '<span style="color: #999;">/*$1*/</span>');
        
        // Add highlight markers for suspicious patterns
        if (highlights && highlights.length > 0) {
          for (const highlight of highlights) {
            if (highlight.pattern) {
              try {
                const regex = new RegExp(`(${highlight.pattern})`, 'g');
                highlightedCode = highlightedCode.replace(regex, 
                  `<span class="bg-red-100 px-1 rounded" title="${highlight.name || 'Suspicious pattern'}">$1</span>`);
              } catch (e) {
                console.error('Regex error in highlighting:', e);
              }
            }
          }
        }
        
        return highlightedCode;
      }
      
      createSafePreview(results) {
        const container = document.getElementById('safePreviewContainer');
        
        // Create a simplified safe preview of the document
        let previewHTML = '';
        
        // Get document title
        const title = results.metadata?.Title || 'Untitled Document';
        
        // Get basic structure
        const pageCount = results.metadata?.pageCount || 0;
        
        // Create preview
        previewHTML += `
          <div class="mb-4 pb-4 border-b">
            <h3 class="text-xl font-bold mb-2">${this.escapeHtml(title)}</h3>
            <div class="text-sm text-gray-600">
              <span>${pageCount} page(s)</span>
              ${results.metadata?.Author ? ` â€¢ Author: ${this.escapeHtml(results.metadata.Author)}` : ''}
              ${results.metadata?.CreationDate ? ` â€¢ Created: ${this.escapeHtml(results.metadata.CreationDate)}` : ''}
            </div>
          </div>
        `;
        
        // Extract text sample for preview (first 1000 chars)
        const textSample = results.text ? results.text.substring(0, 1000) : '';
        
        if (textSample) {
          // Format text with paragraphs
          const paragraphs = textSample.split(/\n\n+/).slice(0, 5);
          previewHTML += '<div class="space-y-4">';
          paragraphs.forEach(para => {
            if (para.trim()) {
              previewHTML += `<p>${this.escapeHtml(para)}</p>`;
            }
          });
          previewHTML += '</div>';
          
          // Add "more" indicator if text was truncated
          if (results.text.length > 1000) {
            previewHTML += '<div class="mt-4 text-center text-gray-400">[ Content truncated for preview ]</div>';
          }
        } else {
          previewHTML += '<div class="text-center py-4 text-gray-500">No text content available for preview</div>';
        }
        
        container.innerHTML = previewHTML;
      }
      
      displayNetworkAnalysis(networkRefs) {
        const tableContainer = document.getElementById('networkActivityTable');
        const vizContainer = document.getElementById('networkVisualization');
        
        if (!networkRefs || networkRefs.length === 0) {
          tableContainer.innerHTML = '<div class="text-center py-4 text-gray-500">No network references detected</div>';
          vizContainer.innerHTML = '<div class="text-center py-4 text-gray-500">No domain connections to visualize</div>';
          return;
        }
        
        // Display network references table
        let tableHTML = `
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="border px-2 py-1 text-left">URL</th>
                <th class="border px-2 py-1 text-left">Source</th>
                <th class="border px-2 py-1 text-left">Risk Level</th>
                <th class="border px-2 py-1 text-left">Reason</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        networkRefs.forEach(ref => {
          const riskClass = ref.risk.level === 'critical' ? 'bg-red-50' :
                          ref.risk.level === 'high' ? 'bg-orange-50' :
                          ref.risk.level === 'medium' ? 'bg-yellow-50' : '';
          
          tableHTML += `
            <tr class="${riskClass}">
              <td class="border px-2 py-1 font-mono text-xs break-all">${this.escapeHtml(ref.url)}</td>
              <td class="border px-2 py-1">${this.escapeHtml(ref.source)}</td>
              <td class="border px-2 py-1 font-semibold">${ref.risk.level.toUpperCase()}</td>
              <td class="border px-2 py-1">${ref.risk.reason || 'Unknown'}</td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        tableContainer.innerHTML = tableHTML;
        
        // Create network visualization
        this.createNetworkVisualization(networkRefs, vizContainer);
      }
      
      createNetworkVisualization(networkRefs, container) {
        // Extract domains from URLs
        const domains = {};
        const documentNode = { id: 'document', name: 'PDF Document', type: 'document' };
        const nodes = [documentNode];
        const links = [];
        
        // Process URLs to extract domains
        networkRefs.forEach(ref => {
          try {
            const url = new URL(ref.url);
            const domain = url.hostname;
            
            if (!domain) return;
            
            if (!domains[domain]) {
              domains[domain] = {
                id: domain,
                name: domain,
                type: 'domain',
                risk: ref.risk.level,
                count: 1
              };
              nodes.push(domains[domain]);
              links.push({
                source: 'document',
                target: domain,
                risk: ref.risk.level
              });
            } else {
              domains[domain].count++;
              // Update risk to highest level
              if (this.getSeverityWeight(ref.risk.level) > this.getSeverityWeight(domains[domain].risk)) {
                domains[domain].risk = ref.risk.level;
                // Update link risk level too
                const link = links.find(l => l.target === domain);
                if (link) link.risk = ref.risk.level;
              }
            }
          } catch (e) {
            console.warn('Invalid URL in network refs:', ref.url);
          }
        });
        
        // Create D3 visualization
        const width = container.clientWidth;
        const height = 300;
        
        container.innerHTML = '';
        const svg = d3.select(container)
          .append("svg")
          .attr("width", width)
          .attr("height", height);
        
        // Create simulation
        const simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(links).id(d => d.id).distance(100))
          .force("charge", d3.forceManyBody().strength(-400))
          .force("center", d3.forceCenter(width / 2, height / 2));
        
        // Create links
        const link = svg.append("g")
          .selectAll("line")
          .data(links)
          .enter().append("line")
          .attr("stroke-width", d => Math.sqrt(d.value) + 1)
          .attr("stroke", d => {
            if (d.risk === 'critical') return "#ef4444";
            if (d.risk === 'high') return "#f97316";
            if (d.risk === 'medium') return "#eab308";
            return "#3b82f6";
          });
        
        // Create nodes
        const node = svg.append("g")
          .selectAll("g")
          .data(nodes)
          .enter().append("g")
          .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));
        
        // Add circles to nodes
        node.append("circle")
          .attr("r", d => d.type === 'document' ? 15 : 8 + Math.sqrt(d.count || 1) * 2)
          .attr("fill", d => {
            if (d.type === 'document') return "#4f46e5";
            if (d.risk === 'critical') return "#ef4444";
            if (d.risk === 'high') return "#f97316";
            if (d.risk === 'medium') return "#eab308";
            return "#3b82f6";
          })
          .attr("stroke", "#ffffff")
          .attr("stroke-width", 1.5);
        
        // Add labels to nodes
        node.append("text")
          .attr("dx", d => d.type === 'document' ? 0 : 12)
          .attr("dy", ".35em")
          .attr("text-anchor", d => d.type === 'document' ? "middle" : "start")
          .text(d => d.name)
          .clone(true).lower()
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 3);
        
        // Update positions
        simulation.on("tick", () => {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
          
          node
            .attr("transform", d => `translate(${d.x},${d.y})`);
        });
        
        // Drag functions
        function dragstarted(event) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          event.subject.fx = event.subject.x;
          event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
          event.subject.fx = event.x;
          event.subject.fy = event.y;
        }
        
        function dragended(event) {
          if (!event.active) simulation.alphaTarget(0);
          event.subject.fx = null;
          event.subject.fy = null;
        }
      }
      
      displayRecommendations(recommendations) {
        const container = document.getElementById('securityRecommendations');
        
        if (!recommendations || recommendations.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-gray-500">No recommendations available</div>';
          return;
        }
        
        let html = '';
        
        // Group by priority
        const byPriority = {
          critical: [],
          high: [],
          medium: [],
          low: []
        };
        
        recommendations.forEach(rec => {
          if (byPriority[rec.priority]) {
            byPriority[rec.priority].push(rec);
          } else {
            byPriority.medium.push(rec);
          }
        });
        
        // Critical recommendations
        if (byPriority.critical.length > 0) {
          html += `
            <div class="mb-6">
              <h4 class="text-lg font-semibold mb-4 text-red-700">Critical Recommendations</h4>
              <div class="space-y-4">
          `;
          
          byPriority.critical.forEach(rec => {
            html += `
              <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg vulnerability-detail">
                <h5 class="font-bold text-red-800">${rec.title}</h5>
                <p class="mt-2">${rec.description}</p>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
        // High recommendations
        if (byPriority.high.length > 0) {
          html += `
            <div class="mb-6">
              <h4 class="text-lg font-semibold mb-4 text-orange-700">High Priority Recommendations</h4>
              <div class="space-y-4">
          `;
          
          byPriority.high.forEach(rec => {
            html += `
              <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-lg vulnerability-detail">
                <h5 class="font-bold text-orange-800">${rec.title}</h5>
                <p class="mt-2">${rec.description}</p>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
        // Medium recommendations
        if (byPriority.medium.length > 0) {
          html += `
            <div class="mb-6">
              <h4 class="text-lg font-semibold mb-4 text-yellow-700">Recommendations</h4>
              <div class="space-y-4">
          `;
          
          byPriority.medium.forEach(rec => {
            html += `
              <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg recommendation-detail">
                <h5 class="font-bold text-yellow-800">${rec.title}</h5>
                <p class="mt-2">${rec.description}</p>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
        // Low recommendations
        if (byPriority.low.length > 0) {
          html += `
            <div class="mb-6">
              <h4 class="text-lg font-semibold mb-4 text-blue-700">Additional Recommendations</h4>
              <div class="space-y-4">
          `;
          
          byPriority.low.forEach(rec => {
            html += `
              <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg recommendation-detail">
                <h5 class="font-bold text-blue-800">${rec.title}</h5>
                <p class="mt-2">${rec.description}</p>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
        container.innerHTML = html;
      }
      
      exportReport(format) {
        if (!this.lastResults) {
          this.showNotification('No scan results to export', 'warning');
          return;
        }
        
        const results = this.lastResults;
        const timestamp = new Date().toISOString();
        
        if (format === 'json') {
          const report = { 
            timestamp, 
            fileInfo: results.fileProperties,
            results: results
          };
          
          const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
          this.downloadFile(blob, `pdf-security-report-${timestamp}.json`);
        }
        else if (format === 'csv') {
          // Create CSV for security findings
          let csv = 'Category,Severity,Source,Matches,Description,Pattern\n';
          
          for (const [category, findings] of Object.entries(results.security)) {
            for (const finding of findings) {
              csv += `"${category}","${finding.severity}","${finding.source}",${finding.matches},"${finding.description || 'Pattern match'}","${finding.pattern}"\n`;
            }
          }
          
          const blob = new Blob([csv], { type: 'text/csv' });
          this.downloadFile(blob, `pdf-security-report-${timestamp}.csv`);
        }
        else if (format === 'html') {
          // Generate HTML report
          const htmlReport = this.generateHTMLReport(results, timestamp);
          const blob = new Blob([htmlReport], { type: 'text/html' });
          this.downloadFile(blob, `pdf-security-report-${timestamp}.html`);
        }
        else if (format === 'pdf') {
          this.showNotification('PDF export is not implemented in this demo', 'info');
        }
      }
      
      generateHTMLReport(results, timestamp) {
        // This is a simplified HTML report generator
        return `
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PDF Security Report</title>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; color: #333; }
              .container { max-width: 1000px; margin: 0 auto; }
              h1, h2, h3 { color: #2563eb; }
              .header { border-bottom: 2px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 20px; }
              .summary { display: flex; justify-content: space-between; margin-bottom: 30px; }
              .summary-card { background: #f9fafb; border-radius: 8px; padding: 15px; width: 22%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
              .summary-card h3 { margin-top: 0; margin-bottom: 10px; }
              .summary-card .value { font-size: 24px; font-weight: bold; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
              th, td { text-align: left; padding: 10px; border-bottom: 1px solid #e5e7eb; }
              th { background-color: #f3f4f6; }
              .critical { background-color: #fee2e2; }
              .high { background-color: #ffedd5; }
              .medium { background-color: #fef3c7; }
              .low { background-color: #dbeafe; }
              .footer { margin-top: 50px; border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; font-size: 12px; color: #6b7280; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>PDF Security Analysis Report</h1>
                <p>Generated on: ${new Date(timestamp).toLocaleString()}</p>
                <p>File: ${results.fileProperties.name} (${results.fileProperties.sizeFormatted})</p>
                <p>Hash: ${results.fileHash}</p>
              </div>
              
              <div class="summary">
                <div class="summary-card">
                  <h3>Threat Score</h3>
                  <div class="value" style="color: ${results.stats.threatColor || 'black'}">${results.stats.threatScore}</div>
                  <div>${results.stats.threatVerdict}</div>
                </div>
                <div class="summary-card">
                  <h3>Critical Issues</h3>
                  <div class="value" style="color: #dc2626">${results.stats.criticalIssues}</div>
                </div>
                <div class="summary-card">
                  <h3>High Issues</h3>
                  <div class="value" style="color: #ea580c">${results.stats.highIssues}</div>
                </div>
                <div class="summary-card">
                  <h3>Total Issues</h3>
                  <div class="value">${results.stats.totalIssues}</div>
                </div>
              </div>
              
              <h2>Security Issues</h2>
              <table>
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Severity</th>
                    <th>Description</th>
                    <th>Matches</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(results.security).flatMap(([category, findings]) => 
                    findings.map(finding => `
                      <tr class="${finding.severity}">
                        <td>${this.formatCategoryName(category)}</td>
                        <td>${finding.severity.toUpperCase()}</td>
                        <td>${finding.description || 'Pattern match'}</td>
                        <td>${finding.matches}</td>
                        <td>${finding.source}</td>
                      </tr>
                    `).join('')
                  ).join('')}
                </tbody>
              </table>
              
              <h2>Document Information</h2>
              <table>
                <tbody>
                  <tr>
                    <td>Title</td>
                    <td>${results.metadata?.Title || 'Not specified'}</td>
                  </tr>
                  <tr>
                    <td>Author</td>
                    <td>${results.metadata?.Author || 'Not specified'}</td>
                  </tr>
                  <tr>
                    <td>Creator</td>
                    <td>${results.metadata?.Creator || 'Not specified'}</td>
                  </tr>
                  <tr>
                    <td>Producer</td>
                    <td>${results.metadata?.Producer || 'Not specified'}</td>
                  </tr>
                  <tr>
                    <td>Created</td>
                    <td>${results.metadata?.CreationDate || 'Not specified'}</td>
                  </tr>
                  <tr>
                    <td>Modified</td>
                    <td>${results.metadata?.ModDate || 'Not specified'}</td>
                  </tr>
                  <tr>
                    <td>Pages</td>
                    <td>${results.metadata?.pageCount || 0}</td>
                  </tr>
                  <tr>
                    <td>PDF Version</td>
                    <td>${results.metadata?.version || 'Unknown'}</td>
                  </tr>
                </tbody>
              </table>
              
              <h2>Recommendations</h2>
              <ul>
                ${results.recommendations.map(rec => `
                  <li>
                    <strong>${rec.title}</strong>: ${rec.description}
                  </li>
                `).join('')}
              </ul>
              
              <div class="footer">
                <p>Generated by Advanced PDF Security Scanner Pro</p>
              </div>
            </div>
          </body>
          </html>
        `;
      }
      
      downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showNotification(`Report "${filename}" downloaded`, 'success');
      }
      
      showNotification(message, type = 'info') {
        // This is a placeholder for a notification system
        // In a real implementation, this would show a toast notification
        
        // For now, use alert for simplicity
        alert(message);
      }
      
      switchTab(tabId) {
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tabId);
        });
        
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.toggle('hidden', content.id !== `${tabId}Tab`);
        });
      }
      
      escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      
      formatCategoryName(category) {
        return category
          .replace(/([A-Z])/g, ' $1')
          .replace(/^./, str => str.toUpperCase())
          .trim();
      }
      
      getSeverityColorClass(severity) {
        if (severity === 'critical') return 'bg-red-50 border-red-500 text-red-700';
        if (severity === 'high') return 'bg-orange-50 border-orange-500 text-orange-700';
        if (severity === 'medium') return 'bg-yellow-50 border-yellow-500 text-yellow-700';
        if (severity === 'low') return 'bg-green-50 border-green-500 text-green-700';
        return 'border-gray-300';
      }
      
      getSeverityColor(severity) {
        if (severity === 'critical') return 'text-red-700 border-red-500';
        if (severity === 'high') return 'text-orange-700 border-orange-500';
        if (severity === 'medium') return 'text-yellow-700 border-yellow-500';
        if (severity === 'low') return 'text-green-700 border-green-500';
        return 'text-gray-700 border-gray-300';
      }
      
      getSeverityWeight(severity) {
        if (severity === 'critical') return 100;
        if (severity === 'high') return 70;
        if (severity === 'medium') return 40;
        if (severity === 'low') return 10;
        return 0;
      }
      
      getScanLevelName(level) {
        if (level === 'quick') return 'Quick Scan';
        if (level === 'deep') return 'Deep Scan';
        if (level === 'forensic') return 'Forensic Analysis';
        return 'Standard Scan';
      }
      
      formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " bytes";
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
        else return (bytes / 1048576).toFixed(1) + " MB";
      }
      
      generateDocumentPropertiesHTML(results, fileName) {
        return `
          <div class="grid grid-cols-2 gap-2">
            <div class="font-semibold">File Name:</div>
            <div>${fileName}</div>
            <div class="font-semibold">File Size:</div>
            <div>${results.fileProperties.sizeFormatted}</div>
            <div class="font-semibold">Scan Level:</div>
            <div>${this.getScanLevelName(results.fileProperties.scanLevel)}</div>
            <div class="font-semibold">Pages:</div>
            <div>${results.metadata.pageCount}</div>
            <div class="font-semibold">Version:</div>
            <div>PDF ${results.metadata.version}</div>
            <div class="font-semibold">Encrypted:</div>
            <div>${results.metadata.encrypted ? 'Yes' : 'No'}</div>
            <div class="font-semibold">File Hash:</div>
            <div class="text-xs break-all">${results.fileHash}</div>
          </div>
        `;
      }
    }
    
    // ==============================================
    // INITIALIZATION
    // ==============================================
    
    function initializeEventListeners() {
      // Add global click listener for collapsible sections
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('node-toggle')) {
          e.target.classList.toggle('open');
          const content = e.target.nextElementSibling;
          if (content.classList.contains('collapsible-section')) {
            if (content.style.maxHeight) {
              content.style.maxHeight = null;
            } else {
              content.style.maxHeight = content.scrollHeight + "px";
            }
          }
        }
      });
    }
    
    // Initialize the UI handler when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      const ui = new UIHandler();
    });
  </script>
<script>
    // Initialize PDF.js worker and setup event listeners when the page loads
    window.onload = function() {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
      
      // Initialize event listeners for collapsible sections
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('node-toggle')) {
          e.target.classList.toggle('open');
          const content = e.target.nextElementSibling;
          if (content.classList.contains('collapsible-section')) {
            if (content.style.maxHeight) {
              content.style.maxHeight = null;
            } else {
              content.style.maxHeight = content.scrollHeight + "px";
            }
          }
        }
      });
      
      // Initialize the UI handler
      window.pdfScannerUI = new UIHandler();
    }
    
    // Helper function to populate info tab content
    function populateInfoTab() {
      const container = document.getElementById("securityRecommendations");
      if (!container) return;
      
      let html = `
        <div class="mb-6">
          <h4 class="text-lg font-semibold mb-4 text-gray-700">Detection Categories</h4>
          <ul class="list-disc pl-5 space-y-2">
      `;
      
      for (const [key, value] of Object.entries(securityPatterns)) {
        html += `<li><strong>${key}</strong>: ${value.description}</li>`;
      }
      
      html += `
          </ul>
        </div>
      `;
      
      // Store the original content so it's not lost
      if (!container.dataset.originalContent) {
        container.dataset.originalContent = container.innerHTML;
      }
      
      container.innerHTML = html;
    }
  </script>
</body>
</html>